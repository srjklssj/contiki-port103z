<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Contiki 2.5: /cygdrive/e/share/contiki/cpu/avr/radio/rf230/radio.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Contiki 2.5</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_8250ce792a7fa8cc4c5147b6b30e941a.html">cpu</a>      </li>
      <li class="navelem"><a class="el" href="dir_e102115dc4fd9eecb7894f42c4695349.html">avr</a>      </li>
      <li class="navelem"><a class="el" href="dir_62ab393b3802ae50a7f696c295092abb.html">radio</a>      </li>
      <li class="navelem"><a class="el" href="dir_c2d39445602e5f1ee6a67b67d48f2805.html">rf230</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">radio.c</div>  </div>
</div>
<div class="contents">
<a href="a00771.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*   Copyright (c) 2008, Swedish Institute of Computer Science</span>
<a name="l00002"></a>00002 <span class="comment"> *  All rights reserved.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> *  Additional fixes for AVR contributed by:</span>
<a name="l00005"></a>00005 <span class="comment"> *      Colin O&#39;Flynn coflynn@newae.com</span>
<a name="l00006"></a>00006 <span class="comment"> *      Eric Gnoske egnoske@gmail.com</span>
<a name="l00007"></a>00007 <span class="comment"> *      Blake Leverett bleverett@gmail.com</span>
<a name="l00008"></a>00008 <span class="comment"> *      Mike Vidales mavida404@gmail.com</span>
<a name="l00009"></a>00009 <span class="comment"> *      Kevin Brown kbrown3@uccs.edu</span>
<a name="l00010"></a>00010 <span class="comment"> *      Nate Bohlmann nate@elfwerks.com</span>
<a name="l00011"></a>00011 <span class="comment"> *</span>
<a name="l00012"></a>00012 <span class="comment"> *   All rights reserved.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> *   Redistribution and use in source and binary forms, with or without</span>
<a name="l00015"></a>00015 <span class="comment"> *   modification, are permitted provided that the following conditions are met:</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> *   * Redistributions of source code must retain the above copyright</span>
<a name="l00018"></a>00018 <span class="comment"> *     notice, this list of conditions and the following disclaimer.</span>
<a name="l00019"></a>00019 <span class="comment"> *   * Redistributions in binary form must reproduce the above copyright</span>
<a name="l00020"></a>00020 <span class="comment"> *     notice, this list of conditions and the following disclaimer in</span>
<a name="l00021"></a>00021 <span class="comment"> *     the documentation and/or other materials provided with the</span>
<a name="l00022"></a>00022 <span class="comment"> *     distribution.</span>
<a name="l00023"></a>00023 <span class="comment"> *   * Neither the name of the copyright holders nor the names of</span>
<a name="l00024"></a>00024 <span class="comment"> *     contributors may be used to endorse or promote products derived</span>
<a name="l00025"></a>00025 <span class="comment"> *     from this software without specific prior written permission.</span>
<a name="l00026"></a>00026 <span class="comment"> *</span>
<a name="l00027"></a>00027 <span class="comment"> *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span>
<a name="l00028"></a>00028 <span class="comment"> *  AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<a name="l00029"></a>00029 <span class="comment"> *  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<a name="l00030"></a>00030 <span class="comment"> *  ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</span>
<a name="l00031"></a>00031 <span class="comment"> *  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<a name="l00032"></a>00032 <span class="comment"> *  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<a name="l00033"></a>00033 <span class="comment"> *  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
<a name="l00034"></a>00034 <span class="comment"> *  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
<a name="l00035"></a>00035 <span class="comment"> *  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<a name="l00036"></a>00036 <span class="comment"> *  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<a name="l00037"></a>00037 <span class="comment"> *  POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00038"></a>00038 <span class="comment"> *</span>
<a name="l00039"></a>00039 <span class="comment"> * $Id: radio.c,v 1.5 2010/02/12 18:00:30 dak664 Exp $</span>
<a name="l00040"></a>00040 <span class="comment">*/</span>
<a name="l00041"></a>00041 <span class="comment"></span>
<a name="l00042"></a>00042 <span class="comment">/**</span>
<a name="l00043"></a>00043 <span class="comment"> *  \brief This module contains the radio driver code for the Atmel</span>
<a name="l00044"></a>00044 <span class="comment"> *  AT86RF230, &#39;231, and &#39;212 chips.</span>
<a name="l00045"></a>00045 <span class="comment"> *</span>
<a name="l00046"></a>00046 <span class="comment"> *  \author Blake Leverett &lt;bleverett@gmail.com&gt;</span>
<a name="l00047"></a>00047 <span class="comment"> *          Mike Vidales &lt;mavida404@gmail.com&gt;</span>
<a name="l00048"></a>00048 <span class="comment"> *          Eric Gnoske &lt;egnoske@gmail.com&gt;</span>
<a name="l00049"></a>00049 <span class="comment"> *</span>
<a name="l00050"></a>00050 <span class="comment">*/</span>
<a name="l00051"></a>00051 <span class="comment"></span>
<a name="l00052"></a>00052 <span class="comment">/**  \addtogroup wireless</span>
<a name="l00053"></a>00053 <span class="comment"> * @{</span>
<a name="l00054"></a>00054 <span class="comment"> */</span>
<a name="l00055"></a>00055 <span class="comment"></span>
<a name="l00056"></a>00056 <span class="comment">/**</span>
<a name="l00057"></a>00057 <span class="comment"> *  \defgroup radiorf230 RF230 interface</span>
<a name="l00058"></a>00058 <span class="comment"> * @{</span>
<a name="l00059"></a>00059 <span class="comment"> */</span><span class="comment"></span>
<a name="l00060"></a>00060 <span class="comment">/**</span>
<a name="l00061"></a>00061 <span class="comment"> *  \file</span>
<a name="l00062"></a>00062 <span class="comment"> *  This file contains radio driver code.</span>
<a name="l00063"></a>00063 <span class="comment"> *</span>
<a name="l00064"></a>00064 <span class="comment"> */</span>
<a name="l00065"></a>00065 
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 <span class="comment">/*============================ INCLUDE =======================================*/</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include &lt;util/delay.h&gt;</span>
<a name="l00071"></a>00071 <span class="preprocessor">#include &quot;radio.h&quot;</span>
<a name="l00072"></a>00072 <span class="preprocessor">#include &quot;hal.h&quot;</span>
<a name="l00073"></a>00073 <span class="preprocessor">#include &quot;<a class="code" href="a00461.html" title="Header file for the Contiki process interface.">process.h</a>&quot;</span>
<a name="l00074"></a>00074 <span class="preprocessor">#include &quot;sicslowmac.h&quot;</span>
<a name="l00075"></a>00075 <span class="preprocessor">#include &quot;<a class="code" href="a00766.html" title="802.15.4 frame creation and parsing functions">frame.h</a>&quot;</span>
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 <span class="comment">/*============================ MACROS ========================================*/</span>
<a name="l00078"></a><a class="code" href="a01710.html#ga49000742b7bdcc563445f80ca9eb5fea">00078</a> <span class="preprocessor">#define RADIO_CCA_DONE_MASK     (1 &lt;&lt; 7) </span><span class="comment">/**&lt;  Mask used to check the CCA_DONE bit. */</span>
<a name="l00079"></a><a class="code" href="a01710.html#gad6f40027f61f63521388768c473dde45">00079</a> <span class="preprocessor">#define RADIO_CCA_IDLE_MASK     (1 &lt;&lt; 6) </span><span class="comment">/**&lt;  Mask used to check the CCA_STATUS bit. */</span>
<a name="l00080"></a>00080 
<a name="l00081"></a><a class="code" href="a01710.html#ga86e1de74faf20f0824aeac0c65a70235">00081</a> <span class="preprocessor">#define RADIO_START_CCA (1) </span><span class="comment">/**&lt;  Value in the CCA_REQUEST subregister that initiate a cca. */</span>
<a name="l00082"></a>00082 
<a name="l00083"></a>00083 <span class="preprocessor">#define RADIO_TRANSMISSION_SUCCESS  (0)</span>
<a name="l00084"></a>00084 <span class="preprocessor"></span><span class="preprocessor">#define RADIO_BUSY_CHANNEL          (3)</span>
<a name="l00085"></a>00085 <span class="preprocessor"></span><span class="preprocessor">#define RADIO_MIN_IEEE_FRAME_LENGTH (5)</span>
<a name="l00086"></a>00086 <span class="preprocessor"></span><span class="comment">/*============================ TYPEDEFS ======================================*/</span>
<a name="l00087"></a>00087 <span class="comment"></span>
<a name="l00088"></a>00088 <span class="comment">/** \brief  This enumeration defines the necessary timing information for the</span>
<a name="l00089"></a>00089 <span class="comment"> *          AT86RF230 radio transceiver. All times are in microseconds.</span>
<a name="l00090"></a>00090 <span class="comment"> *</span>
<a name="l00091"></a>00091 <span class="comment"> *          These constants are extracted from the datasheet.</span>
<a name="l00092"></a>00092 <span class="comment"> */</span>
<a name="l00093"></a><a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08d">00093</a> <span class="keyword">typedef</span> <span class="keyword">enum</span>{
<a name="l00094"></a><a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08dab843ffee3072fd1cb0582955224b6764">00094</a>     <a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08dab843ffee3072fd1cb0582955224b6764" title="Transition time from VCC is applied to P_ON.">TIME_TO_ENTER_P_ON</a>               = 510, <span class="comment">/**&lt;  Transition time from VCC is applied to P_ON. */</span>
<a name="l00095"></a><a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08dab9de5983d25a9b788432f79eeebbda1f">00095</a>     <a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08dab9de5983d25a9b788432f79eeebbda1f" title="Transition time from P_ON to TRX_OFF.">TIME_P_ON_TO_TRX_OFF</a>             = 510, <span class="comment">/**&lt;  Transition time from P_ON to TRX_OFF. */</span>
<a name="l00096"></a><a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08da7067e6c59db93ac323c375140eff1c51">00096</a>     <a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08da7067e6c59db93ac323c375140eff1c51" title="Transition time from SLEEP to TRX_OFF.">TIME_SLEEP_TO_TRX_OFF</a>            = 880, <span class="comment">/**&lt;  Transition time from SLEEP to TRX_OFF. */</span>
<a name="l00097"></a><a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08da7987806807cc7ffc8afcafe42665af0f">00097</a>     <a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08da7987806807cc7ffc8afcafe42665af0f" title="Time to hold the RST pin low during reset.">TIME_RESET</a>                       = 6,   <span class="comment">/**&lt;  Time to hold the RST pin low during reset */</span>
<a name="l00098"></a><a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08dacd603365652239fc2d4cef5c4f2dcf23">00098</a>     <a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08dacd603365652239fc2d4cef5c4f2dcf23" title="Time it takes to do a ED measurement.">TIME_ED_MEASUREMENT</a>              = 140, <span class="comment">/**&lt;  Time it takes to do a ED measurement. */</span>
<a name="l00099"></a><a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08da40b984895797d7656266f48b724f2206">00099</a>     <a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08da40b984895797d7656266f48b724f2206" title="Time it takes to do a CCA.">TIME_CCA</a>                         = 140, <span class="comment">/**&lt;  Time it takes to do a CCA. */</span>
<a name="l00100"></a><a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08dae5b568fca41fce82055b00269565b7ef">00100</a>     <a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08dae5b568fca41fce82055b00269565b7ef" title="Maximum time it should take for the PLL to lock.">TIME_PLL_LOCK</a>                    = 150, <span class="comment">/**&lt;  Maximum time it should take for the PLL to lock. */</span>
<a name="l00101"></a><a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08dacbada1dc573b954bad0184f6b111c02b">00101</a>     <a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08dacbada1dc573b954bad0184f6b111c02b" title="Maximum time it should take to do the filter tuning.">TIME_FTN_TUNING</a>                  = 25,  <span class="comment">/**&lt;  Maximum time it should take to do the filter tuning. */</span>
<a name="l00102"></a><a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08da60b95807cc5d2690b9ee459c861c6a6c">00102</a>     <a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08da60b95807cc5d2690b9ee459c861c6a6c" title="Transition time from *_NOCLK to being awake.">TIME_NOCLK_TO_WAKE</a>               = 6,   <span class="comment">/**&lt;  Transition time from *_NOCLK to being awake. */</span>
<a name="l00103"></a><a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08daf50b81813c269484256d8d02b3751b4f">00103</a>     <a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08daf50b81813c269484256d8d02b3751b4f" title="Time it takes to execute the FORCE_TRX_OFF command.">TIME_CMD_FORCE_TRX_OFF</a>           = 1,    <span class="comment">/**&lt;  Time it takes to execute the FORCE_TRX_OFF command. */</span>
<a name="l00104"></a><a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08dab69e9ed03883d6e427ea2027fb3daf13">00104</a>     <a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08dab69e9ed03883d6e427ea2027fb3daf13" title="Transition time from TRX_OFF to: RX_ON, PLL_ON, TX_ARET_ON and RX_AACK_ON.">TIME_TRX_OFF_TO_PLL_ACTIVE</a>       = 180, <span class="comment">/**&lt;  Transition time from TRX_OFF to: RX_ON, PLL_ON, TX_ARET_ON and RX_AACK_ON. */</span>
<a name="l00105"></a><a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08daa68a9b1ecf13ab8095e32d86d35d416b">00105</a>     <a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08daa68a9b1ecf13ab8095e32d86d35d416b" title="Transition time from PLL active state to another.">TIME_STATE_TRANSITION_PLL_ACTIVE</a> = 1, <span class="comment">/**&lt;  Transition time from PLL active state to another. */</span>
<a name="l00106"></a>00106 }<a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08d" title="This enumeration defines the necessary timing information for the AT86RF230 radio transceiver...">radio_trx_timing_t</a>;
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 <span class="comment">/*============================ VARIABLES =====================================*/</span>
<a name="l00109"></a>00109 <span class="keyword">static</span> <a class="code" href="a01709.html#ga3797f6d7a265fcfc4e68e1a5bf7a1a27" title="RX_START event handler callback type.">hal_rx_start_isr_event_handler_t</a> user_rx_event;
<a name="l00110"></a>00110 <span class="keyword">static</span> <a class="code" href="a01709.html#ga29b8c4b915c81726d8c390fe76171cce" title="RRX_END event handler callback type.">hal_trx_end_isr_event_handler_t</a> user_trx_end_event;
<a name="l00111"></a>00111 <span class="keyword">static</span> radio_rx_callback rx_frame_callback;
<a name="l00112"></a>00112 <span class="keyword">static</span> uint8_t rssi_val;
<a name="l00113"></a>00113 <span class="keyword">static</span> uint8_t rx_mode;
<a name="l00114"></a>00114 uint8_t rxMode = <a class="code" href="a00763.html#afddeaef97c7252f303f60355d79bf04c" title="Constant RX_AACK_ON for sub-register SR_TRX_STATUS.">RX_AACK_ON</a>;
<a name="l00115"></a>00115 
<a name="l00116"></a>00116 <span class="comment">/* See clock.c and httpd-cgi.c for RADIOSTATS code */</span>
<a name="l00117"></a>00117 <span class="preprocessor">#define RADIOSTATS 0</span>
<a name="l00118"></a>00118 <span class="preprocessor"></span><span class="preprocessor">#if RADIOSTATS</span>
<a name="l00119"></a>00119 <span class="preprocessor"></span>uint8_t RF230_radio_on, RF230_rsigsi;
<a name="l00120"></a>00120 uint16_t RF230_sendpackets,RF230_receivepackets,RF230_sendfail,RF230_receivefail;
<a name="l00121"></a>00121 <span class="preprocessor">#endif</span>
<a name="l00122"></a>00122 <span class="preprocessor"></span>
<a name="l00123"></a>00123 <span class="keyword">static</span> <a class="code" href="a00053.html" title="This struct defines the rx data container.">hal_rx_frame_t</a> rx_frame;
<a name="l00124"></a>00124 <span class="keyword">static</span> parsed_frame_t parsed_frame;
<a name="l00125"></a>00125 
<a name="l00126"></a>00126 <span class="comment">/*============================ PROTOTYPES ====================================*/</span>
<a name="l00127"></a>00127 <span class="keywordtype">bool</span> <a class="code" href="a01710.html#ga7c4b1fbd30174589d1a0660f30a543e3" title="This function checks if the radio transceiver is sleeping.">radio_is_sleeping</a>(<span class="keywordtype">void</span>);
<a name="l00128"></a>00128 <span class="keyword">static</span> <span class="keywordtype">void</span> radio_rx_start_event(uint32_t <span class="keyword">const</span> isr_timestamp, uint8_t <span class="keyword">const</span> frame_length);
<a name="l00129"></a>00129 <span class="keyword">static</span> <span class="keywordtype">void</span> radio_trx_end_event(uint32_t <span class="keyword">const</span> isr_timestamp);
<a name="l00130"></a>00130 <span class="comment"></span>
<a name="l00131"></a>00131 <span class="comment">/** \brief  Initialize the Transceiver Access Toolbox and lower layers.</span>
<a name="l00132"></a>00132 <span class="comment"> *</span>
<a name="l00133"></a>00133 <span class="comment"> *          If the initialization is successful the radio transceiver will be in</span>
<a name="l00134"></a>00134 <span class="comment"> *          TRX_OFF state.</span>
<a name="l00135"></a>00135 <span class="comment"> *</span>
<a name="l00136"></a>00136 <span class="comment"> *  \note  This function must be called prior to any of the other functions in</span>
<a name="l00137"></a>00137 <span class="comment"> *         this file! Can be called from any transceiver state.</span>
<a name="l00138"></a>00138 <span class="comment"> *</span>
<a name="l00139"></a>00139 <span class="comment"> *  \param cal_rc_osc If true, the radio&#39;s accurate clock is used to calibrate the</span>
<a name="l00140"></a>00140 <span class="comment"> *                    CPU&#39;s internal RC oscillator.</span>
<a name="l00141"></a>00141 <span class="comment"> *</span>
<a name="l00142"></a>00142 <span class="comment"> *  \param rx_event Optional pointer to a user-defined function to be called on an</span>
<a name="l00143"></a>00143 <span class="comment"> *                  RX_START interrupt.  Use NULL for no handler.</span>
<a name="l00144"></a>00144 <span class="comment"> *</span>
<a name="l00145"></a>00145 <span class="comment"> *  \param trx_end_event Optional pointer to a user-defined function to be called on an</span>
<a name="l00146"></a>00146 <span class="comment"> *                  TRX_END interrupt.  Use NULL for no handler.</span>
<a name="l00147"></a>00147 <span class="comment"> *</span>
<a name="l00148"></a>00148 <span class="comment"> *  \param rx_callback Optional pointer to a user-defined function that receives</span>
<a name="l00149"></a>00149 <span class="comment"> *         a frame from the radio one byte at a time.  If the index parameter to</span>
<a name="l00150"></a>00150 <span class="comment"> *         this callback is 0xff, then the function should reset its state and prepare</span>
<a name="l00151"></a>00151 <span class="comment"> *         for a frame from the radio, with one call per byte.</span>
<a name="l00152"></a>00152 <span class="comment"> *</span>
<a name="l00153"></a>00153 <span class="comment"> *  \retval RADIO_SUCCESS     The radio transceiver was successfully initialized</span>
<a name="l00154"></a>00154 <span class="comment"> *                          and put into the TRX_OFF state.</span>
<a name="l00155"></a>00155 <span class="comment"> *  \retval RADIO_UNSUPPORTED_DEVICE  The connected device is not an Atmel</span>
<a name="l00156"></a>00156 <span class="comment"> *                                  AT86RF230 radio transceiver.</span>
<a name="l00157"></a>00157 <span class="comment"> *  \retval RADIO_TIMED_OUT   The radio transceiver was not able to initialize and</span>
<a name="l00158"></a>00158 <span class="comment"> *                          enter TRX_OFF state within the specified time.</span>
<a name="l00159"></a>00159 <span class="comment"> */</span>
<a name="l00160"></a>00160 <a class="code" href="a01710.html#gab6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a>
<a name="l00161"></a><a class="code" href="a01710.html#ga4e9853fe6b340a6f000cdfd1134d7597">00161</a> <a class="code" href="a01710.html#ga4e9853fe6b340a6f000cdfd1134d7597" title="Initialize the Transceiver Access Toolbox and lower layers.">radio_init</a>(<span class="keywordtype">bool</span> cal_rc_osc,
<a name="l00162"></a>00162            <a class="code" href="a01709.html#ga3797f6d7a265fcfc4e68e1a5bf7a1a27" title="RX_START event handler callback type.">hal_rx_start_isr_event_handler_t</a> rx_event,
<a name="l00163"></a>00163            <a class="code" href="a01709.html#ga29b8c4b915c81726d8c390fe76171cce" title="RRX_END event handler callback type.">hal_trx_end_isr_event_handler_t</a> trx_end_event,
<a name="l00164"></a>00164            radio_rx_callback rx_callback)
<a name="l00165"></a>00165 {
<a name="l00166"></a>00166     <a class="code" href="a01710.html#gab6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a> init_status = <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ae0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l00167"></a>00167 
<a name="l00168"></a>00168     delay_us(<a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08dab843ffee3072fd1cb0582955224b6764" title="Transition time from VCC is applied to P_ON.">TIME_TO_ENTER_P_ON</a>);
<a name="l00169"></a>00169 
<a name="l00170"></a>00170     <span class="comment">/*  calibrate oscillator */</span>
<a name="l00171"></a>00171     <span class="keywordflow">if</span> (cal_rc_osc){
<a name="l00172"></a>00172         <a class="code" href="a01710.html#gaaa84b1c0e7ec53220e17cabca6832b52" title="Calibrate the internal RC oscillator.">calibrate_rc_osc_32k</a>();
<a name="l00173"></a>00173     }
<a name="l00174"></a>00174 
<a name="l00175"></a>00175     <span class="comment">/* Initialize Hardware Abstraction Layer. */</span>
<a name="l00176"></a>00176     <a class="code" href="a01709.html#gaf5ea8985a12feedc3ac25fbb50712183" title="This function initializes the Hardware Abstraction Layer.">hal_init</a>();
<a name="l00177"></a>00177 
<a name="l00178"></a>00178     <a class="code" href="a01710.html#ga54684d521cdfbb1f049443846c73f10f" title="This function will reset all the registers and the state machine of the radio transceiver.">radio_reset_trx</a>(); <span class="comment">/* Do HW reset of radio transeiver. */</span>
<a name="l00179"></a>00179 
<a name="l00180"></a>00180     <span class="comment">/* Force transition to TRX_OFF. */</span>
<a name="l00181"></a>00181     <a class="code" href="a01709.html#ga3577f9187e7d5af04be3fd1377307ffa" title="This function writes a new value to one of the radio transceiver&#39;s subregisters.">hal_subregister_write</a>(<a class="code" href="a00763.html#a8d912618842812f37fc46356eff73c93" title="Access parameters for sub-register TRX_CMD in register RG_TRX_STATE.">SR_TRX_CMD</a>, <a class="code" href="a00763.html#a8ecc63755abb125691b00426cba7fe41" title="Constant CMD_FORCE_TRX_OFF for sub-register SR_TRX_CMD.">CMD_FORCE_TRX_OFF</a>);
<a name="l00182"></a>00182     delay_us(<a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08dab9de5983d25a9b788432f79eeebbda1f" title="Transition time from P_ON to TRX_OFF.">TIME_P_ON_TO_TRX_OFF</a>); <span class="comment">/* Wait for the transition to be complete. */</span>
<a name="l00183"></a>00183 
<a name="l00184"></a>00184     <span class="keywordflow">if</span> (<a class="code" href="a01710.html#ga8e301ea5e85cf022a857a892f98b4a62" title="This function return the Radio Transceivers current state.">radio_get_trx_state</a>() != <a class="code" href="a00763.html#ad9aff3d987888b9d1bcb9fc12d2c996e" title="Constant TRX_OFF for sub-register SR_TRX_STATUS.">TRX_OFF</a>){
<a name="l00185"></a>00185         init_status = <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ac1e26b7c1be4cb9607efaa1967061bd7" title="The requested service timed out.">RADIO_TIMED_OUT</a>;
<a name="l00186"></a>00186     } <span class="keywordflow">else</span> {
<a name="l00187"></a>00187         <span class="comment">/* Read Version Number */</span>
<a name="l00188"></a>00188         uint8_t version_number = <a class="code" href="a01709.html#gaf3c702dd022b52907dc882a346a16819" title="This function reads data from one of the radio transceiver&#39;s registers.">hal_register_read</a>(<a class="code" href="a00763.html#ac1888aaec44899f2a3d7856b757533e8" title="Offset for register VERSION_NUM.">RG_VERSION_NUM</a>);
<a name="l00189"></a>00189 
<a name="l00190"></a>00190         <span class="keywordflow">if</span> ((version_number != RF230_REVA) &amp;&amp; (version_number != RF230_REVB))
<a name="l00191"></a>00191             init_status = <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73a053f75192c9eeb244880ef68d103246d" title="The connected device is not an Atmel AT86RF230.">RADIO_UNSUPPORTED_DEVICE</a>;
<a name="l00192"></a>00192         <span class="keywordflow">else</span> {
<a name="l00193"></a>00193             <span class="keywordflow">if</span> (<a class="code" href="a01709.html#gaf3c702dd022b52907dc882a346a16819" title="This function reads data from one of the radio transceiver&#39;s registers.">hal_register_read</a>(<a class="code" href="a00763.html#a3514dae6641c832c5223c74151544f17" title="Offset for register MAN_ID_0.">RG_MAN_ID_0</a>) != SUPPORTED_MANUFACTURER_ID)
<a name="l00194"></a>00194                 init_status = <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73a053f75192c9eeb244880ef68d103246d" title="The connected device is not an Atmel AT86RF230.">RADIO_UNSUPPORTED_DEVICE</a>;
<a name="l00195"></a>00195             <span class="keywordflow">else</span>
<a name="l00196"></a>00196                 <a class="code" href="a01709.html#ga733238be74ad06adfc1720e56427a447" title="This function writes a new value to one of the radio transceiver&#39;s registers.">hal_register_write</a>(<a class="code" href="a00763.html#a905b648376932649f2af990f20a03df6" title="Offset for register IRQ_MASK.">RG_IRQ_MASK</a>, RF230_SUPPORTED_INTERRUPT_MASK);
<a name="l00197"></a>00197         }
<a name="l00198"></a>00198 <span class="preprocessor">#if RADIOSTATS</span>
<a name="l00199"></a>00199 <span class="preprocessor"></span>        RF230_radio_on = 1;
<a name="l00200"></a>00200 <span class="preprocessor">#endif</span>
<a name="l00201"></a>00201 <span class="preprocessor"></span>    }
<a name="l00202"></a>00202 
<a name="l00203"></a>00203     <span class="comment">/*  set callbacks for events.  Save user&#39;s rx_event, which we will */</span>
<a name="l00204"></a>00204     <span class="comment">/*  call from radio_rx_start_event().  Same with trx_end */</span>
<a name="l00205"></a>00205     user_rx_event = rx_event;
<a name="l00206"></a>00206     user_trx_end_event = trx_end_event;
<a name="l00207"></a>00207     <a class="code" href="a01709.html#gabe75f8512838143045c3e54598edf199" title="This function is used to set new RX_START event handler, overriding old handler reference.">hal_set_rx_start_event_handler</a>(radio_rx_start_event);
<a name="l00208"></a>00208     <a class="code" href="a01709.html#gabc5b49e953f6d324cb3b4efe6a86d431" title="This function is used to set new TRX_END event handler, overriding old handler reference.">hal_set_trx_end_event_handler</a>(radio_trx_end_event);
<a name="l00209"></a>00209 
<a name="l00210"></a>00210     rx_frame_callback = rx_callback;
<a name="l00211"></a>00211 
<a name="l00212"></a>00212     <span class="keywordflow">return</span> init_status;
<a name="l00213"></a>00213 }
<a name="l00214"></a>00214 
<a name="l00215"></a>00215 <span class="comment">/*---------------------------------------------------------------------------*/</span>
<a name="l00216"></a>00216 uint8_t *
<a name="l00217"></a>00217 radio_frame_data(<span class="keywordtype">void</span>)
<a name="l00218"></a>00218 {
<a name="l00219"></a>00219         <span class="keywordflow">return</span> rx_frame.<a class="code" href="a00053.html#a5d23f15b3b8e39774c9a54ee00b544d2" title="Actual frame data.">data</a>;
<a name="l00220"></a>00220 }
<a name="l00221"></a>00221 
<a name="l00222"></a>00222 uint8_t
<a name="l00223"></a>00223 radio_frame_length(<span class="keywordtype">void</span>)
<a name="l00224"></a>00224 {
<a name="l00225"></a>00225         <span class="keywordflow">return</span> rx_frame.<a class="code" href="a00053.html#a5bd2554c7ea38ac94a3712af366711c7" title="Length of frame.">length</a>;
<a name="l00226"></a>00226 }
<a name="l00227"></a>00227 
<a name="l00228"></a>00228 <span class="comment">/*---------------------------------------------------------------------------*/</span>
<a name="l00229"></a>00229 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00230"></a>00230 radio_rx_start_event(uint32_t <span class="keyword">const</span> isr_timestamp, uint8_t <span class="keyword">const</span> frame_length)
<a name="l00231"></a>00231 {
<a name="l00232"></a>00232     <span class="comment">/*  save away RSSI */</span>
<a name="l00233"></a>00233     rssi_val =  <a class="code" href="a01709.html#ga3af07027e6111b4d8798bf3b33dce065" title="This function reads the value of a specific subregister.">hal_subregister_read</a>( <a class="code" href="a00763.html#ae4a0fbc6bd43fdcb0272429f5b6edb86" title="Access parameters for sub-register RSSI in register RG_PHY_RSSI.">SR_RSSI</a> );
<a name="l00234"></a>00234 
<a name="l00235"></a>00235     <span class="comment">/*  call user&#39;s rx_start event handler */</span>
<a name="l00236"></a>00236     <span class="keywordflow">if</span> (user_rx_event)
<a name="l00237"></a>00237         user_rx_event(isr_timestamp, frame_length);
<a name="l00238"></a>00238 }
<a name="l00239"></a>00239 
<a name="l00240"></a>00240 <span class="comment">/*---------------------------------------------------------------------------*/</span>
<a name="l00241"></a>00241 uint8_t
<a name="l00242"></a>00242 radio_get_saved_rssi_value(<span class="keywordtype">void</span>)
<a name="l00243"></a>00243 {
<a name="l00244"></a>00244     <span class="keywordflow">return</span> rssi_val;
<a name="l00245"></a>00245 }
<a name="l00246"></a>00246 
<a name="l00247"></a>00247 <span class="comment">/*---------------------------------------------------------------------------*/</span>
<a name="l00248"></a>00248 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00249"></a>00249 radio_trx_end_event(uint32_t <span class="keyword">const</span> isr_timestamp)
<a name="l00250"></a>00250 {
<a name="l00251"></a>00251     <span class="keyword">volatile</span> uint8_t status;
<a name="l00252"></a>00252 
<a name="l00253"></a>00253     <span class="comment">/*  call user&#39;s trx_end event handler */</span>
<a name="l00254"></a>00254     <span class="keywordflow">if</span> (user_trx_end_event){
<a name="l00255"></a>00255         user_trx_end_event(isr_timestamp);
<a name="l00256"></a>00256         <span class="keywordflow">return</span>;
<a name="l00257"></a>00257     }
<a name="l00258"></a>00258     <span class="keywordflow">if</span> (rx_mode){
<a name="l00259"></a>00259         <span class="comment">/* radio has received frame, store it away */</span>
<a name="l00260"></a>00260 <span class="preprocessor">#if RADIOSTATS</span>
<a name="l00261"></a>00261 <span class="preprocessor"></span>        RF230_rsigsi=rssi_val;
<a name="l00262"></a>00262         RF230_receivepackets++;
<a name="l00263"></a>00263 <span class="preprocessor">#endif</span>
<a name="l00264"></a>00264 <span class="preprocessor"></span>        parsed_frame.time = isr_timestamp;
<a name="l00265"></a>00265         parsed_frame.rssi = rssi_val;
<a name="l00266"></a>00266         
<a name="l00267"></a>00267         <a class="code" href="a01709.html#gacfaa15085246889b14044feb4141ca59" title="This function will upload a frame from the radio transceiver&#39;s frame buffer.">hal_frame_read</a>(&amp;rx_frame, <a class="code" href="a01762.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4" title="The null pointer.">NULL</a>);
<a name="l00268"></a>00268         <a class="code" href="a01708.html#ga5b6553d68f25a7a9e4884b1f9384a07d" title="Parses an input frame.">rx_frame_parse</a>(&amp;rx_frame, &amp;parsed_frame);
<a name="l00269"></a>00269         }
<a name="l00270"></a>00270 
<a name="l00271"></a>00271     <span class="keywordflow">if</span> (!rx_mode){
<a name="l00272"></a>00272         <span class="comment">/*  Put radio back into receive mode. */</span>
<a name="l00273"></a>00273         <a class="code" href="a01710.html#ga06b43a13b2efd1a4e0c1b9ae7a204c81" title="This function will change the current state of the radio transceiver&#39;s internal state machine...">radio_set_trx_state</a>(<a class="code" href="a00763.html#ad9aff3d987888b9d1bcb9fc12d2c996e" title="Constant TRX_OFF for sub-register SR_TRX_STATUS.">TRX_OFF</a>);
<a name="l00274"></a>00274         <a class="code" href="a01710.html#ga06b43a13b2efd1a4e0c1b9ae7a204c81" title="This function will change the current state of the radio transceiver&#39;s internal state machine...">radio_set_trx_state</a>(rxMode);
<a name="l00275"></a>00275 
<a name="l00276"></a>00276         <span class="comment">/*  transmit mode, put end-of-transmit event in queue */</span>
<a name="l00277"></a>00277         event_object_t event;
<a name="l00278"></a>00278         <span class="keyword">event</span>.event = 0;
<a name="l00279"></a>00279         <span class="keyword">event</span>.data = 0;
<a name="l00280"></a>00280         status = <a class="code" href="a01709.html#ga3af07027e6111b4d8798bf3b33dce065" title="This function reads the value of a specific subregister.">hal_subregister_read</a>(<a class="code" href="a00763.html#a4692d9ea2770ff145d1c35c513cbf1d6" title="Access parameters for sub-register TRAC_STATUS in register RG_TRX_STATE.">SR_TRAC_STATUS</a>);
<a name="l00281"></a>00281         <span class="keywordflow">switch</span>(status){
<a name="l00282"></a>00282         <span class="keywordflow">case</span> TRAC_SUCCESS:
<a name="l00283"></a>00283         <span class="keywordflow">case</span> TRAC_SUCCESS_DATA_PENDING:
<a name="l00284"></a>00284             <span class="keyword">event</span>.event = MAC_EVENT_ACK;
<a name="l00285"></a>00285             <span class="keywordflow">break</span>;
<a name="l00286"></a>00286         <span class="keywordflow">case</span> TRAC_NO_ACK:
<a name="l00287"></a>00287         <span class="keywordflow">case</span> TRAC_CHANNEL_ACCESS_FAILURE:
<a name="l00288"></a>00288             <span class="keyword">event</span>.event = MAC_EVENT_NACK;
<a name="l00289"></a>00289 <span class="preprocessor">#if RADIOSTATS</span>
<a name="l00290"></a>00290 <span class="preprocessor"></span>        RF230_sendfail++;
<a name="l00291"></a>00291 <span class="preprocessor">#endif</span>
<a name="l00292"></a>00292 <span class="preprocessor"></span>            <span class="keywordflow">break</span>;
<a name="l00293"></a>00293         <span class="keywordflow">case</span> TRAC_SUCCESS_WAIT_FOR_ACK:
<a name="l00294"></a>00294             <span class="comment">/*  should only happen in RX mode */</span>
<a name="l00295"></a>00295         <span class="keywordflow">case</span> TRAC_INVALID:
<a name="l00296"></a>00296             <span class="comment">/*  should never happen here */</span>
<a name="l00297"></a>00297         <span class="keywordflow">default</span>:
<a name="l00298"></a>00298 <span class="preprocessor">#if RADIOSTATS</span>
<a name="l00299"></a>00299 <span class="preprocessor"></span>            RF230_sendfail++;
<a name="l00300"></a>00300 <span class="preprocessor">#endif</span>
<a name="l00301"></a>00301 <span class="preprocessor"></span>            <span class="keywordflow">break</span>;
<a name="l00302"></a>00302         }
<a name="l00303"></a>00303         <span class="keywordflow">if</span> (event.event)
<a name="l00304"></a>00304             <a class="code" href="a00287.html#a546b1497ed4c233b1bbfcc34c0b386be" title="Puts an event into the queue of events.">mac_put_event</a>(&amp;event);
<a name="l00305"></a>00305         <a class="code" href="a01684.html#gab9d3fbbf6273dd3f0da62887c4433d39" title="Post an asynchronous event.">process_post</a>(&amp;mac_process, event.event, event.data);
<a name="l00306"></a>00306     }
<a name="l00307"></a>00307 }
<a name="l00308"></a>00308 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00309"></a>00309 <span class="comment">/** \brief  This function will return the channel used by the radio transceiver.</span>
<a name="l00310"></a>00310 <span class="comment"> *</span>
<a name="l00311"></a>00311 <span class="comment"> *  \return Current channel, 11 to 26.</span>
<a name="l00312"></a>00312 <span class="comment"> */</span>
<a name="l00313"></a>00313 uint8_t
<a name="l00314"></a><a class="code" href="a01710.html#ga918bfcb229236b545ff18ffbabef1288">00314</a> <a class="code" href="a01710.html#ga918bfcb229236b545ff18ffbabef1288" title="This function will return the channel used by the radio transceiver.">radio_get_operating_channel</a>(<span class="keywordtype">void</span>)
<a name="l00315"></a>00315 {
<a name="l00316"></a>00316     <span class="keywordflow">return</span> <a class="code" href="a01709.html#ga3af07027e6111b4d8798bf3b33dce065" title="This function reads the value of a specific subregister.">hal_subregister_read</a>(<a class="code" href="a00763.html#a4b9bff87f5d63f845e3fad83286624db" title="Access parameters for sub-register CHANNEL in register RG_PHY_CC_CCA.">SR_CHANNEL</a>);
<a name="l00317"></a>00317 }
<a name="l00318"></a>00318 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00319"></a>00319 <span class="comment">/** \brief This function will change the operating channel.</span>
<a name="l00320"></a>00320 <span class="comment"> *</span>
<a name="l00321"></a>00321 <span class="comment"> *  \param  channel New channel to operate on. Must be between 11 and 26.</span>
<a name="l00322"></a>00322 <span class="comment"> *</span>
<a name="l00323"></a>00323 <span class="comment"> *  \retval RADIO_SUCCESS New channel set.</span>
<a name="l00324"></a>00324 <span class="comment"> *  \retval RADIO_WRONG_STATE Transceiver is in a state where the channel cannot</span>
<a name="l00325"></a>00325 <span class="comment"> *                          be changed (SLEEP).</span>
<a name="l00326"></a>00326 <span class="comment"> *  \retval RADIO_INVALID_ARGUMENT Channel argument is out of bounds.</span>
<a name="l00327"></a>00327 <span class="comment"> *  \retval RADIO_TIMED_OUT The PLL did not lock within the specified time.</span>
<a name="l00328"></a>00328 <span class="comment"> */</span>
<a name="l00329"></a>00329 <a class="code" href="a01710.html#gab6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a>
<a name="l00330"></a><a class="code" href="a01710.html#gaa16555040f23e644c73eb0204dbb6204">00330</a> <a class="code" href="a01710.html#gaa16555040f23e644c73eb0204dbb6204" title="This function will change the operating channel.">radio_set_operating_channel</a>(uint8_t channel)
<a name="l00331"></a>00331 {
<a name="l00332"></a>00332     <span class="comment">/*Do function parameter and state check.*/</span>
<a name="l00333"></a>00333     <span class="keywordflow">if</span> ((channel &lt; RF230_MIN_CHANNEL) ||
<a name="l00334"></a>00334         (channel &gt; RF230_MAX_CHANNEL)){
<a name="l00335"></a>00335         <span class="keywordflow">return</span> <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73a9dc11f55b8f5a813e72002eb36710389" title="One or more of the supplied function arguments are invalid.">RADIO_INVALID_ARGUMENT</a>;
<a name="l00336"></a>00336     }
<a name="l00337"></a>00337 
<a name="l00338"></a>00338     <span class="keywordflow">if</span> (<a class="code" href="a01710.html#ga7c4b1fbd30174589d1a0660f30a543e3" title="This function checks if the radio transceiver is sleeping.">radio_is_sleeping</a>() == <span class="keyword">true</span>){
<a name="l00339"></a>00339         <span class="keywordflow">return</span> <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ae2cba4f4b63e5ff3c6e3a4bbbb1358e5" title="The end-user tried to do an invalid state transition.">RADIO_WRONG_STATE</a>;
<a name="l00340"></a>00340     }
<a name="l00341"></a>00341 
<a name="l00342"></a>00342     <span class="keywordflow">if</span> (<a class="code" href="a01710.html#ga918bfcb229236b545ff18ffbabef1288" title="This function will return the channel used by the radio transceiver.">radio_get_operating_channel</a>() == channel){
<a name="l00343"></a>00343         <span class="keywordflow">return</span> <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ae0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l00344"></a>00344     }
<a name="l00345"></a>00345 
<a name="l00346"></a>00346     <span class="comment">/*Set new operating channel.*/</span>
<a name="l00347"></a>00347     <a class="code" href="a01709.html#ga3577f9187e7d5af04be3fd1377307ffa" title="This function writes a new value to one of the radio transceiver&#39;s subregisters.">hal_subregister_write</a>(<a class="code" href="a00763.html#a4b9bff87f5d63f845e3fad83286624db" title="Access parameters for sub-register CHANNEL in register RG_PHY_CC_CCA.">SR_CHANNEL</a>, channel);
<a name="l00348"></a>00348 
<a name="l00349"></a>00349     <span class="comment">/* Read current state and wait for the PLL_LOCK interrupt if the */</span>
<a name="l00350"></a>00350     <span class="comment">/* radio transceiver is in either RX_ON or PLL_ON. */</span>
<a name="l00351"></a>00351     uint8_t trx_state = <a class="code" href="a01710.html#ga8e301ea5e85cf022a857a892f98b4a62" title="This function return the Radio Transceivers current state.">radio_get_trx_state</a>();
<a name="l00352"></a>00352 
<a name="l00353"></a>00353     <span class="keywordflow">if</span> ((trx_state == <a class="code" href="a00763.html#a359db88bcffa6b39bdb64ec00ec3a1ae" title="Constant RX_ON for sub-register SR_TRX_STATUS.">RX_ON</a>) ||
<a name="l00354"></a>00354         (trx_state == <a class="code" href="a00763.html#a77a32ac338596fe95ea09d7603d7c295" title="Constant PLL_ON for sub-register SR_TRX_STATUS.">PLL_ON</a>)){
<a name="l00355"></a>00355         delay_us(<a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08dae5b568fca41fce82055b00269565b7ef" title="Maximum time it should take for the PLL to lock.">TIME_PLL_LOCK</a>);
<a name="l00356"></a>00356     }
<a name="l00357"></a>00357 
<a name="l00358"></a>00358     <a class="code" href="a01710.html#gab6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a> channel_set_status = <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ac1e26b7c1be4cb9607efaa1967061bd7" title="The requested service timed out.">RADIO_TIMED_OUT</a>;
<a name="l00359"></a>00359 
<a name="l00360"></a>00360     <span class="comment">/* Check that the channel was set properly. */</span>
<a name="l00361"></a>00361     <span class="keywordflow">if</span> (<a class="code" href="a01710.html#ga918bfcb229236b545ff18ffbabef1288" title="This function will return the channel used by the radio transceiver.">radio_get_operating_channel</a>() == channel){
<a name="l00362"></a>00362         channel_set_status = <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ae0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l00363"></a>00363     }
<a name="l00364"></a>00364 
<a name="l00365"></a>00365     <span class="keywordflow">return</span> channel_set_status;
<a name="l00366"></a>00366 }
<a name="l00367"></a>00367 
<a name="l00368"></a>00368 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00369"></a>00369 <span class="comment">/** \brief This function will read and return the output power level.</span>
<a name="l00370"></a>00370 <span class="comment"> *</span>
<a name="l00371"></a>00371 <span class="comment"> *  \returns 0 to 15 Current output power in &quot;TX power settings&quot; as defined in</span>
<a name="l00372"></a>00372 <span class="comment"> *          the radio transceiver&#39;s datasheet</span>
<a name="l00373"></a>00373 <span class="comment"> */</span>
<a name="l00374"></a>00374 uint8_t
<a name="l00375"></a><a class="code" href="a01710.html#ga424fe6e9473de76b6c8b8ed206b00ae1">00375</a> <a class="code" href="a01710.html#ga424fe6e9473de76b6c8b8ed206b00ae1" title="This function will read and return the output power level.">radio_get_tx_power_level</a>(<span class="keywordtype">void</span>)
<a name="l00376"></a>00376 {
<a name="l00377"></a>00377     <span class="keywordflow">return</span> <a class="code" href="a01709.html#ga3af07027e6111b4d8798bf3b33dce065" title="This function reads the value of a specific subregister.">hal_subregister_read</a>(<a class="code" href="a00763.html#a34ec89db5926c2c2348dbc587629a9e8" title="Access parameters for sub-register TX_PWR in register RG_PHY_TX_PWR.">SR_TX_PWR</a>);
<a name="l00378"></a>00378 }
<a name="l00379"></a>00379 
<a name="l00380"></a>00380 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00381"></a>00381 <span class="comment">/** \brief This function will change the output power level.</span>
<a name="l00382"></a>00382 <span class="comment"> *</span>
<a name="l00383"></a>00383 <span class="comment"> *  \param  power_level New output power level in the &quot;TX power settings&quot;</span>
<a name="l00384"></a>00384 <span class="comment"> *                      as defined in the radio transceiver&#39;s datasheet.</span>
<a name="l00385"></a>00385 <span class="comment"> *</span>
<a name="l00386"></a>00386 <span class="comment"> *  \retval RADIO_SUCCESS New output power set successfully.</span>
<a name="l00387"></a>00387 <span class="comment"> *  \retval RADIO_INVALID_ARGUMENT The supplied function argument is out of bounds.</span>
<a name="l00388"></a>00388 <span class="comment"> *  \retval RADIO_WRONG_STATE It is not possible to change the TX power when the</span>
<a name="l00389"></a>00389 <span class="comment"> *                          device is sleeping.</span>
<a name="l00390"></a>00390 <span class="comment"> */</span>
<a name="l00391"></a>00391 <a class="code" href="a01710.html#gab6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a>
<a name="l00392"></a><a class="code" href="a01710.html#ga12275c916e1d9def7ea31d2cc3a80c65">00392</a> <a class="code" href="a01710.html#ga12275c916e1d9def7ea31d2cc3a80c65" title="This function will change the output power level.">radio_set_tx_power_level</a>(uint8_t power_level)
<a name="l00393"></a>00393 {
<a name="l00394"></a>00394 
<a name="l00395"></a>00395     <span class="comment">/*Check function parameter and state.*/</span>
<a name="l00396"></a>00396     <span class="keywordflow">if</span> (power_level &gt; TX_PWR_17_2DBM){
<a name="l00397"></a>00397         <span class="keywordflow">return</span> <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73a9dc11f55b8f5a813e72002eb36710389" title="One or more of the supplied function arguments are invalid.">RADIO_INVALID_ARGUMENT</a>;
<a name="l00398"></a>00398     }
<a name="l00399"></a>00399 
<a name="l00400"></a>00400     <span class="keywordflow">if</span> (<a class="code" href="a01710.html#ga7c4b1fbd30174589d1a0660f30a543e3" title="This function checks if the radio transceiver is sleeping.">radio_is_sleeping</a>() == <span class="keyword">true</span>){
<a name="l00401"></a>00401         <span class="keywordflow">return</span> <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ae2cba4f4b63e5ff3c6e3a4bbbb1358e5" title="The end-user tried to do an invalid state transition.">RADIO_WRONG_STATE</a>;
<a name="l00402"></a>00402     }
<a name="l00403"></a>00403 
<a name="l00404"></a>00404     <span class="comment">/*Set new power level*/</span>
<a name="l00405"></a>00405     <a class="code" href="a01709.html#ga3577f9187e7d5af04be3fd1377307ffa" title="This function writes a new value to one of the radio transceiver&#39;s subregisters.">hal_subregister_write</a>(<a class="code" href="a00763.html#a34ec89db5926c2c2348dbc587629a9e8" title="Access parameters for sub-register TX_PWR in register RG_PHY_TX_PWR.">SR_TX_PWR</a>, power_level);
<a name="l00406"></a>00406 
<a name="l00407"></a>00407     <span class="keywordflow">return</span> <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ae0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l00408"></a>00408 }
<a name="l00409"></a>00409 
<a name="l00410"></a>00410 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00411"></a>00411 <span class="comment">/** \brief This function returns the current CCA mode used.</span>
<a name="l00412"></a>00412 <span class="comment"> *</span>
<a name="l00413"></a>00413 <span class="comment"> *  \return CCA mode currently used, 0 to 3.</span>
<a name="l00414"></a>00414 <span class="comment"> */</span>
<a name="l00415"></a>00415 uint8_t
<a name="l00416"></a><a class="code" href="a01710.html#ga6cae5bc6e98ef4a519dc5664492a4ffb">00416</a> <a class="code" href="a01710.html#ga6cae5bc6e98ef4a519dc5664492a4ffb" title="This function returns the current CCA mode used.">radio_get_cca_mode</a>(<span class="keywordtype">void</span>)
<a name="l00417"></a>00417 {
<a name="l00418"></a>00418     <span class="keywordflow">return</span> <a class="code" href="a01709.html#ga3af07027e6111b4d8798bf3b33dce065" title="This function reads the value of a specific subregister.">hal_subregister_read</a>(<a class="code" href="a00763.html#a5f1683f4ba650a0737bf0a4cce54da51" title="Access parameters for sub-register CCA_MODE in register RG_PHY_CC_CCA.">SR_CCA_MODE</a>);
<a name="l00419"></a>00419 }
<a name="l00420"></a>00420 
<a name="l00421"></a>00421 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00422"></a>00422 <span class="comment">/** \brief This function returns the current ED threshold used by the CCA algorithm.</span>
<a name="l00423"></a>00423 <span class="comment"> *</span>
<a name="l00424"></a>00424 <span class="comment"> *  \return Current ED threshold, 0 to 15.</span>
<a name="l00425"></a>00425 <span class="comment"> */</span>
<a name="l00426"></a>00426 uint8_t
<a name="l00427"></a><a class="code" href="a01710.html#ga04a68fa37dfc2849ae68ad7380c4beb3">00427</a> <a class="code" href="a01710.html#ga04a68fa37dfc2849ae68ad7380c4beb3" title="This function returns the current ED threshold used by the CCA algorithm.">radio_get_ed_threshold</a>(<span class="keywordtype">void</span>)
<a name="l00428"></a>00428 {
<a name="l00429"></a>00429     <span class="keywordflow">return</span> <a class="code" href="a01709.html#ga3af07027e6111b4d8798bf3b33dce065" title="This function reads the value of a specific subregister.">hal_subregister_read</a>(<a class="code" href="a00763.html#a5d49fade58407955545f861fc65078b9" title="Access parameters for sub-register CCA_ED_THRES in register RG_CCA_THRES.">SR_CCA_ED_THRES</a>);
<a name="l00430"></a>00430 }
<a name="l00431"></a>00431 
<a name="l00432"></a>00432 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00433"></a>00433 <span class="comment">/** \brief This function will configure the Clear Channel Assessment algorithm.</span>
<a name="l00434"></a>00434 <span class="comment"> *</span>
<a name="l00435"></a>00435 <span class="comment"> *  \param  mode Three modes are available: Energy above threshold, carrier</span>
<a name="l00436"></a>00436 <span class="comment"> *               sense only and carrier sense with energy above threshold.</span>
<a name="l00437"></a>00437 <span class="comment"> *  \param  ed_threshold Above this energy threshold the channel is assumed to be</span>
<a name="l00438"></a>00438 <span class="comment"> *                      busy. The threshold is given in positive dBm values.</span>
<a name="l00439"></a>00439 <span class="comment"> *                      Ex. -91 dBm gives a csThreshold of 91. Value range for</span>
<a name="l00440"></a>00440 <span class="comment"> *                      the variable is [61 to 91]. Only valid for the CCA_ED</span>
<a name="l00441"></a>00441 <span class="comment"> *                      and CCA_CARRIER_SENSE_ED modes.</span>
<a name="l00442"></a>00442 <span class="comment"> *</span>
<a name="l00443"></a>00443 <span class="comment"> *  \retval RADIO_SUCCESS Mode and its parameters successfully changed.</span>
<a name="l00444"></a>00444 <span class="comment"> *  \retval RADIO_WRONG_STATE This function cannot be called in the SLEEP state.</span>
<a name="l00445"></a>00445 <span class="comment"> *  \retval RADIO_INVALID_ARGUMENT If one of the three function arguments are out</span>
<a name="l00446"></a>00446 <span class="comment"> *                               of bounds.</span>
<a name="l00447"></a>00447 <span class="comment"> */</span>
<a name="l00448"></a>00448 <a class="code" href="a01710.html#gab6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a>
<a name="l00449"></a><a class="code" href="a01710.html#gae6fe9892339b76a7a586fe5d613ab0eb">00449</a> <a class="code" href="a01710.html#gae6fe9892339b76a7a586fe5d613ab0eb" title="This function will configure the Clear Channel Assessment algorithm.">radio_set_cca_mode</a>(uint8_t mode, uint8_t ed_threshold)
<a name="l00450"></a>00450 {
<a name="l00451"></a>00451     <span class="comment">/*Check function parameters and state.*/</span>
<a name="l00452"></a>00452     <span class="keywordflow">if</span> ((mode != <a class="code" href="a01710.html#ggab71d6a3c66ce80ec4c231e5111bf923daa9df48be09d8bf0586bca022e64d06a9" title="Use energy detection above threshold mode.">CCA_ED</a>) &amp;&amp;
<a name="l00453"></a>00453         (mode != <a class="code" href="a01710.html#ggab71d6a3c66ce80ec4c231e5111bf923daeae3badd37859833ee1708f4d251928d" title="Use carrier sense mode.">CCA_CARRIER_SENSE</a>) &amp;&amp;
<a name="l00454"></a>00454         (mode != <a class="code" href="a01710.html#ggab71d6a3c66ce80ec4c231e5111bf923daf274aea74cda340a393d7ba839dd04f7" title="Use a combination of both energy detection and carrier sense.">CCA_CARRIER_SENSE_WITH_ED</a>)){
<a name="l00455"></a>00455         <span class="keywordflow">return</span> <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73a9dc11f55b8f5a813e72002eb36710389" title="One or more of the supplied function arguments are invalid.">RADIO_INVALID_ARGUMENT</a>;
<a name="l00456"></a>00456     }
<a name="l00457"></a>00457 
<a name="l00458"></a>00458     <span class="comment">/* Ensure that the ED threshold is within bounds. */</span>
<a name="l00459"></a>00459     <span class="keywordflow">if</span> (ed_threshold &gt; RF230_MAX_ED_THRESHOLD){
<a name="l00460"></a>00460         <span class="keywordflow">return</span> <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73a9dc11f55b8f5a813e72002eb36710389" title="One or more of the supplied function arguments are invalid.">RADIO_INVALID_ARGUMENT</a>;
<a name="l00461"></a>00461     }
<a name="l00462"></a>00462 
<a name="l00463"></a>00463     <span class="comment">/* Ensure that the radio transceiver is not sleeping. */</span>
<a name="l00464"></a>00464     <span class="keywordflow">if</span> (<a class="code" href="a01710.html#ga7c4b1fbd30174589d1a0660f30a543e3" title="This function checks if the radio transceiver is sleeping.">radio_is_sleeping</a>() == <span class="keyword">true</span>){
<a name="l00465"></a>00465         <span class="keywordflow">return</span> <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ae2cba4f4b63e5ff3c6e3a4bbbb1358e5" title="The end-user tried to do an invalid state transition.">RADIO_WRONG_STATE</a>;
<a name="l00466"></a>00466     }
<a name="l00467"></a>00467 
<a name="l00468"></a>00468     <span class="comment">/*Change cca mode and ed threshold.*/</span>
<a name="l00469"></a>00469     <a class="code" href="a01709.html#ga3577f9187e7d5af04be3fd1377307ffa" title="This function writes a new value to one of the radio transceiver&#39;s subregisters.">hal_subregister_write</a>(<a class="code" href="a00763.html#a5f1683f4ba650a0737bf0a4cce54da51" title="Access parameters for sub-register CCA_MODE in register RG_PHY_CC_CCA.">SR_CCA_MODE</a>, mode);
<a name="l00470"></a>00470     <a class="code" href="a01709.html#ga3577f9187e7d5af04be3fd1377307ffa" title="This function writes a new value to one of the radio transceiver&#39;s subregisters.">hal_subregister_write</a>(<a class="code" href="a00763.html#a5d49fade58407955545f861fc65078b9" title="Access parameters for sub-register CCA_ED_THRES in register RG_CCA_THRES.">SR_CCA_ED_THRES</a>, ed_threshold);
<a name="l00471"></a>00471 
<a name="l00472"></a>00472     <span class="keywordflow">return</span> <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ae0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l00473"></a>00473 }
<a name="l00474"></a>00474 
<a name="l00475"></a>00475 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00476"></a>00476 <span class="comment">/** \brief This function returns the Received Signal Strength Indication.</span>
<a name="l00477"></a>00477 <span class="comment"> *</span>
<a name="l00478"></a>00478 <span class="comment"> *  \note This function should only be called from the: RX_ON and BUSY_RX. This</span>
<a name="l00479"></a>00479 <span class="comment"> *        can be ensured by reading the current state of the radio transceiver</span>
<a name="l00480"></a>00480 <span class="comment"> *        before executing this function!</span>
<a name="l00481"></a>00481 <span class="comment"> *  \param rssi Pointer to memory location where RSSI value should be written.</span>
<a name="l00482"></a>00482 <span class="comment"> *  \retval RADIO_SUCCESS The RSSI measurement was successful.</span>
<a name="l00483"></a>00483 <span class="comment"> *  \retval RADIO_WRONG_STATE The radio transceiver is not in RX_ON or BUSY_RX.</span>
<a name="l00484"></a>00484 <span class="comment"> */</span>
<a name="l00485"></a>00485 <a class="code" href="a01710.html#gab6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a>
<a name="l00486"></a><a class="code" href="a01710.html#gab67dc7befec87decb8f36ef63eef3b77">00486</a> <a class="code" href="a01710.html#gab67dc7befec87decb8f36ef63eef3b77" title="This function returns the Received Signal Strength Indication.">radio_get_rssi_value</a>(uint8_t *rssi)
<a name="l00487"></a>00487 {
<a name="l00488"></a>00488 
<a name="l00489"></a>00489     uint8_t current_state = <a class="code" href="a01710.html#ga8e301ea5e85cf022a857a892f98b4a62" title="This function return the Radio Transceivers current state.">radio_get_trx_state</a>();
<a name="l00490"></a>00490     <a class="code" href="a01710.html#gab6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a> retval = <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ae2cba4f4b63e5ff3c6e3a4bbbb1358e5" title="The end-user tried to do an invalid state transition.">RADIO_WRONG_STATE</a>;
<a name="l00491"></a>00491 
<a name="l00492"></a>00492     <span class="comment">/*The RSSI measurement should only be done in RX_ON or BUSY_RX.*/</span>
<a name="l00493"></a>00493     <span class="keywordflow">if</span> ((current_state == <a class="code" href="a00763.html#a359db88bcffa6b39bdb64ec00ec3a1ae" title="Constant RX_ON for sub-register SR_TRX_STATUS.">RX_ON</a>) ||
<a name="l00494"></a>00494         (current_state == <a class="code" href="a00763.html#a9486d08d26658473840dd55ef9d59783" title="Constant BUSY_RX for sub-register SR_TRX_STATUS.">BUSY_RX</a>)){
<a name="l00495"></a>00495         *rssi = <a class="code" href="a01709.html#ga3af07027e6111b4d8798bf3b33dce065" title="This function reads the value of a specific subregister.">hal_subregister_read</a>(<a class="code" href="a00763.html#ae4a0fbc6bd43fdcb0272429f5b6edb86" title="Access parameters for sub-register RSSI in register RG_PHY_RSSI.">SR_RSSI</a>);
<a name="l00496"></a>00496         retval = <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ae0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l00497"></a>00497     }
<a name="l00498"></a>00498 
<a name="l00499"></a>00499     <span class="keywordflow">return</span> retval;
<a name="l00500"></a>00500 }
<a name="l00501"></a>00501 
<a name="l00502"></a>00502 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00503"></a>00503 <span class="comment">/** \brief This function returns the current threshold volatge used by the</span>
<a name="l00504"></a>00504 <span class="comment"> *         battery monitor (BATMON_VTH).</span>
<a name="l00505"></a>00505 <span class="comment"> *</span>
<a name="l00506"></a>00506 <span class="comment"> *  \note This function can not be called from P_ON or SLEEP. This is ensured</span>
<a name="l00507"></a>00507 <span class="comment"> *        by reading the device state before calling this function.</span>
<a name="l00508"></a>00508 <span class="comment"> *</span>
<a name="l00509"></a>00509 <span class="comment"> *  \return Current threshold voltage, 0 to 15.</span>
<a name="l00510"></a>00510 <span class="comment"> */</span>
<a name="l00511"></a>00511 uint8_t
<a name="l00512"></a><a class="code" href="a01710.html#ga91158b7dac9c5836ab460fca224e760d">00512</a> <a class="code" href="a01710.html#ga91158b7dac9c5836ab460fca224e760d" title="This function returns the current threshold volatge used by the battery monitor (BATMON_VTH).">radio_batmon_get_voltage_threshold</a>(<span class="keywordtype">void</span>)
<a name="l00513"></a>00513 {
<a name="l00514"></a>00514     <span class="keywordflow">return</span> <a class="code" href="a01709.html#ga3af07027e6111b4d8798bf3b33dce065" title="This function reads the value of a specific subregister.">hal_subregister_read</a>(<a class="code" href="a00763.html#af4d8678ff08d67835ed9fde2e063e524" title="Access parameters for sub-register BATMON_VTH in register RG_BATMON.">SR_BATMON_VTH</a>);
<a name="l00515"></a>00515 }
<a name="l00516"></a>00516 
<a name="l00517"></a>00517 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00518"></a>00518 <span class="comment">/** \brief This function returns if high or low voltage range is used.</span>
<a name="l00519"></a>00519 <span class="comment"> *</span>
<a name="l00520"></a>00520 <span class="comment"> *  \note This function can not be called from P_ON or SLEEP. This is ensured</span>
<a name="l00521"></a>00521 <span class="comment"> *        by reading the device state before calling this function.</span>
<a name="l00522"></a>00522 <span class="comment"> *</span>
<a name="l00523"></a>00523 <span class="comment"> *  \retval 0 Low voltage range selected.</span>
<a name="l00524"></a>00524 <span class="comment"> *  \retval 1 High voltage range selected.</span>
<a name="l00525"></a>00525 <span class="comment"> */</span>
<a name="l00526"></a>00526 uint8_t
<a name="l00527"></a><a class="code" href="a01710.html#gaf516804b4ecd978c1cd1ef91eaaebde4">00527</a> <a class="code" href="a01710.html#gaf516804b4ecd978c1cd1ef91eaaebde4" title="This function returns if high or low voltage range is used.">radio_batmon_get_voltage_range</a>(<span class="keywordtype">void</span>)
<a name="l00528"></a>00528 {
<a name="l00529"></a>00529     <span class="keywordflow">return</span> <a class="code" href="a01709.html#ga3af07027e6111b4d8798bf3b33dce065" title="This function reads the value of a specific subregister.">hal_subregister_read</a>(<a class="code" href="a00763.html#aaade16ed1ba624efbf6a71cb66af9d0f" title="Access parameters for sub-register BATMON_HR in register RG_BATMON.">SR_BATMON_HR</a>);
<a name="l00530"></a>00530 }
<a name="l00531"></a>00531 
<a name="l00532"></a>00532 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00533"></a>00533 <span class="comment">/** \brief This function is used to configure the battery monitor module</span>
<a name="l00534"></a>00534 <span class="comment"> *</span>
<a name="l00535"></a>00535 <span class="comment"> *  \param range True means high voltage range and false low voltage range.</span>
<a name="l00536"></a>00536 <span class="comment"> *  \param voltage_threshold The datasheet defines 16 voltage levels for both</span>
<a name="l00537"></a>00537 <span class="comment"> *                          low and high range.</span>
<a name="l00538"></a>00538 <span class="comment"> *  \retval RADIO_SUCCESS Battery monitor configured</span>
<a name="l00539"></a>00539 <span class="comment"> *  \retval RADIO_WRONG_STATE The device is sleeping.</span>
<a name="l00540"></a>00540 <span class="comment"> *  \retval RADIO_INVALID_ARGUMENT The voltage_threshold parameter is out of</span>
<a name="l00541"></a>00541 <span class="comment"> *                               bounds (Not within [0 - 15]).</span>
<a name="l00542"></a>00542 <span class="comment"> */</span>
<a name="l00543"></a>00543 <a class="code" href="a01710.html#gab6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a>
<a name="l00544"></a><a class="code" href="a01710.html#ga6ddd12093e883498434a1f0502afd223">00544</a> <a class="code" href="a01710.html#ga6ddd12093e883498434a1f0502afd223" title="This function is used to configure the battery monitor module.">radio_batmon_configure</a>(<span class="keywordtype">bool</span> range, uint8_t voltage_threshold)
<a name="l00545"></a>00545 {
<a name="l00546"></a>00546 
<a name="l00547"></a>00547     <span class="comment">/*Check function parameters and state.*/</span>
<a name="l00548"></a>00548     <span class="keywordflow">if</span> (voltage_threshold &gt; BATTERY_MONITOR_HIGHEST_VOLTAGE){
<a name="l00549"></a>00549         <span class="keywordflow">return</span> <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73a9dc11f55b8f5a813e72002eb36710389" title="One or more of the supplied function arguments are invalid.">RADIO_INVALID_ARGUMENT</a>;
<a name="l00550"></a>00550     }
<a name="l00551"></a>00551 
<a name="l00552"></a>00552     <span class="keywordflow">if</span> (<a class="code" href="a01710.html#ga7c4b1fbd30174589d1a0660f30a543e3" title="This function checks if the radio transceiver is sleeping.">radio_is_sleeping</a>() == <span class="keyword">true</span>){
<a name="l00553"></a>00553         <span class="keywordflow">return</span> <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ae2cba4f4b63e5ff3c6e3a4bbbb1358e5" title="The end-user tried to do an invalid state transition.">RADIO_WRONG_STATE</a>;
<a name="l00554"></a>00554     }
<a name="l00555"></a>00555 
<a name="l00556"></a>00556     <span class="comment">/*Write new voltage range and voltage level.*/</span>
<a name="l00557"></a>00557     <span class="keywordflow">if</span> (range == <span class="keyword">true</span>){
<a name="l00558"></a>00558         <a class="code" href="a01709.html#ga3577f9187e7d5af04be3fd1377307ffa" title="This function writes a new value to one of the radio transceiver&#39;s subregisters.">hal_subregister_write</a>(<a class="code" href="a00763.html#aaade16ed1ba624efbf6a71cb66af9d0f" title="Access parameters for sub-register BATMON_HR in register RG_BATMON.">SR_BATMON_HR</a>, BATTERY_MONITOR_HIGH_VOLTAGE);
<a name="l00559"></a>00559     } <span class="keywordflow">else</span> {
<a name="l00560"></a>00560         <a class="code" href="a01709.html#ga3577f9187e7d5af04be3fd1377307ffa" title="This function writes a new value to one of the radio transceiver&#39;s subregisters.">hal_subregister_write</a>(<a class="code" href="a00763.html#aaade16ed1ba624efbf6a71cb66af9d0f" title="Access parameters for sub-register BATMON_HR in register RG_BATMON.">SR_BATMON_HR</a>, BATTERY_MONITOR_LOW_VOLTAGE);
<a name="l00561"></a>00561     }
<a name="l00562"></a>00562 
<a name="l00563"></a>00563     <a class="code" href="a01709.html#ga3577f9187e7d5af04be3fd1377307ffa" title="This function writes a new value to one of the radio transceiver&#39;s subregisters.">hal_subregister_write</a>(<a class="code" href="a00763.html#af4d8678ff08d67835ed9fde2e063e524" title="Access parameters for sub-register BATMON_VTH in register RG_BATMON.">SR_BATMON_VTH</a>, voltage_threshold);
<a name="l00564"></a>00564 
<a name="l00565"></a>00565     <span class="keywordflow">return</span> <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ae0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l00566"></a>00566 }
<a name="l00567"></a>00567 
<a name="l00568"></a>00568 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00569"></a>00569 <span class="comment">/** \brief This function returns the status of the Battery Monitor module.</span>
<a name="l00570"></a>00570 <span class="comment"> *</span>
<a name="l00571"></a>00571 <span class="comment"> *  \note This function can not be called from P_ON or SLEEP. This is ensured</span>
<a name="l00572"></a>00572 <span class="comment"> *        by reading the device state before calling this function.</span>
<a name="l00573"></a>00573 <span class="comment"> *</span>
<a name="l00574"></a>00574 <span class="comment"> *  \retval RADIO_BAT_LOW Battery voltage is below the programmed threshold.</span>
<a name="l00575"></a>00575 <span class="comment"> *  \retval RADIO_BAT_OK Battery voltage is above the programmed threshold.</span>
<a name="l00576"></a>00576 <span class="comment"> */</span>
<a name="l00577"></a>00577 <a class="code" href="a01710.html#gab6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a>
<a name="l00578"></a><a class="code" href="a01710.html#gad33630ec5deaced83d660b18ee8a9a78">00578</a> <a class="code" href="a01710.html#gad33630ec5deaced83d660b18ee8a9a78" title="This function returns the status of the Battery Monitor module.">radio_batmon_get_status</a>(<span class="keywordtype">void</span>)
<a name="l00579"></a>00579 {
<a name="l00580"></a>00580 
<a name="l00581"></a>00581     <a class="code" href="a01710.html#gab6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a> batmon_status = <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73adba268aded546c8ee6aa90fb1b457d09" title="Measured battery voltage is lower than voltage threshold.">RADIO_BAT_LOW</a>;
<a name="l00582"></a>00582 
<a name="l00583"></a>00583     <span class="keywordflow">if</span> (<a class="code" href="a01709.html#ga3af07027e6111b4d8798bf3b33dce065" title="This function reads the value of a specific subregister.">hal_subregister_read</a>(<a class="code" href="a00763.html#acff72bdcbf66f9ef80b51797328f04b4" title="Access parameters for sub-register BATMON_OK in register RG_BATMON.">SR_BATMON_OK</a>) !=
<a name="l00584"></a>00584         BATTERY_MONITOR_VOLTAGE_UNDER_THRESHOLD){
<a name="l00585"></a>00585         batmon_status = <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73a12f567282c526bee93379f8a69a60fb3" title="Measured battery voltage is above the voltage threshold.">RADIO_BAT_OK</a>;
<a name="l00586"></a>00586     }
<a name="l00587"></a>00587 
<a name="l00588"></a>00588     <span class="keywordflow">return</span> batmon_status;
<a name="l00589"></a>00589 }
<a name="l00590"></a>00590 
<a name="l00591"></a>00591 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00592"></a>00592 <span class="comment">/** \brief This function returns the current clock setting for the CLKM pin.</span>
<a name="l00593"></a>00593 <span class="comment"> *</span>
<a name="l00594"></a>00594 <span class="comment"> *  \retval CLKM_DISABLED CLKM pin is disabled.</span>
<a name="l00595"></a>00595 <span class="comment"> *  \retval CLKM_1MHZ CLKM pin is prescaled to 1 MHz.</span>
<a name="l00596"></a>00596 <span class="comment"> *  \retval CLKM_2MHZ CLKM pin is prescaled to 2 MHz.</span>
<a name="l00597"></a>00597 <span class="comment"> *  \retval CLKM_4MHZ CLKM pin is prescaled to 4 MHz.</span>
<a name="l00598"></a>00598 <span class="comment"> *  \retval CLKM_8MHZ CLKM pin is prescaled to 8 MHz.</span>
<a name="l00599"></a>00599 <span class="comment"> *  \retval CLKM_16MHZ CLKM pin is not prescaled. Output is 16 MHz.</span>
<a name="l00600"></a>00600 <span class="comment"> */</span>
<a name="l00601"></a>00601 uint8_t
<a name="l00602"></a><a class="code" href="a01710.html#gafd5fa5fa5a7629d3b940552afbe5c142">00602</a> <a class="code" href="a01710.html#gafd5fa5fa5a7629d3b940552afbe5c142" title="This function returns the current clock setting for the CLKM pin.">radio_get_clock_speed</a>(<span class="keywordtype">void</span>)
<a name="l00603"></a>00603 {
<a name="l00604"></a>00604     <span class="keywordflow">return</span> <a class="code" href="a01709.html#ga3af07027e6111b4d8798bf3b33dce065" title="This function reads the value of a specific subregister.">hal_subregister_read</a>(<a class="code" href="a00763.html#ac108f260911d536daba845f79a0c7eff" title="Access parameters for sub-register CLKM_CTRL in register RG_TRX_CTRL_0.">SR_CLKM_CTRL</a>);
<a name="l00605"></a>00605 }
<a name="l00606"></a>00606 
<a name="l00607"></a>00607 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00608"></a>00608 <span class="comment">/** \brief This function changes the prescaler on the CLKM pin.</span>
<a name="l00609"></a>00609 <span class="comment"> *</span>
<a name="l00610"></a>00610 <span class="comment"> *  \param direct   This boolean variable is used to determine if the frequency</span>
<a name="l00611"></a>00611 <span class="comment"> *                  of the CLKM pin shall be changed directly or not. If direct</span>
<a name="l00612"></a>00612 <span class="comment"> *                  equals true, the frequency will be changed directly. This is</span>
<a name="l00613"></a>00613 <span class="comment"> *                  fine if the CLKM signal is used to drive a timer etc. on the</span>
<a name="l00614"></a>00614 <span class="comment"> *                  connected microcontroller. However, the CLKM signal can also</span>
<a name="l00615"></a>00615 <span class="comment"> *                  be used to clock the microcontroller itself. In this situation</span>
<a name="l00616"></a>00616 <span class="comment"> *                  it is possible to change the CLKM frequency indirectly</span>
<a name="l00617"></a>00617 <span class="comment"> *                  (direct == false). When the direct argument equlas false, the</span>
<a name="l00618"></a>00618 <span class="comment"> *                  CLKM frequency will be changed first after the radio transceiver</span>
<a name="l00619"></a>00619 <span class="comment"> *                  has been taken to SLEEP and awaken again.</span>
<a name="l00620"></a>00620 <span class="comment"> *  \param clock_speed This parameter can be one of the following constants:</span>
<a name="l00621"></a>00621 <span class="comment"> *                     CLKM_DISABLED, CLKM_1MHZ, CLKM_2MHZ, CLKM_4MHZ, CLKM_8MHZ</span>
<a name="l00622"></a>00622 <span class="comment"> *                     or CLKM_16MHZ.</span>
<a name="l00623"></a>00623 <span class="comment"> *</span>
<a name="l00624"></a>00624 <span class="comment"> *  \retval RADIO_SUCCESS Clock speed updated. New state is TRX_OFF.</span>
<a name="l00625"></a>00625 <span class="comment"> *  \retval RADIO_INVALID_ARGUMENT Requested clock speed is out of bounds.</span>
<a name="l00626"></a>00626 <span class="comment"> */</span>
<a name="l00627"></a>00627 <a class="code" href="a01710.html#gab6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a>
<a name="l00628"></a><a class="code" href="a01710.html#gaed81adcaca247848a64a7b612b1df5d5">00628</a> <a class="code" href="a01710.html#gaed81adcaca247848a64a7b612b1df5d5" title="This function changes the prescaler on the CLKM pin.">radio_set_clock_speed</a>(<span class="keywordtype">bool</span> direct, uint8_t clock_speed)
<a name="l00629"></a>00629 {
<a name="l00630"></a>00630         <span class="comment">/*Check function parameter and current clock speed.*/</span>
<a name="l00631"></a>00631     <span class="keywordflow">if</span> (clock_speed &gt; CLKM_16MHZ){
<a name="l00632"></a>00632             <span class="keywordflow">return</span> <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73a9dc11f55b8f5a813e72002eb36710389" title="One or more of the supplied function arguments are invalid.">RADIO_INVALID_ARGUMENT</a>;
<a name="l00633"></a>00633     }
<a name="l00634"></a>00634 
<a name="l00635"></a>00635     <span class="keywordflow">if</span> (<a class="code" href="a01710.html#gafd5fa5fa5a7629d3b940552afbe5c142" title="This function returns the current clock setting for the CLKM pin.">radio_get_clock_speed</a>() == clock_speed){
<a name="l00636"></a>00636         <span class="keywordflow">return</span> <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ae0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l00637"></a>00637     }
<a name="l00638"></a>00638 
<a name="l00639"></a>00639         <span class="comment">/*Select to change the CLKM frequency directly or after returning from SLEEP.*/</span>
<a name="l00640"></a>00640     <span class="keywordflow">if</span> (direct == <span class="keyword">false</span>){
<a name="l00641"></a>00641             <a class="code" href="a01709.html#ga3577f9187e7d5af04be3fd1377307ffa" title="This function writes a new value to one of the radio transceiver&#39;s subregisters.">hal_subregister_write</a>(<a class="code" href="a00763.html#a3517409068f4c36eedae73ed8ffead13" title="Access parameters for sub-register CLKM_SHA_SEL in register RG_TRX_CTRL_0.">SR_CLKM_SHA_SEL</a>, 1);
<a name="l00642"></a>00642     } <span class="keywordflow">else</span> {
<a name="l00643"></a>00643             <a class="code" href="a01709.html#ga3577f9187e7d5af04be3fd1377307ffa" title="This function writes a new value to one of the radio transceiver&#39;s subregisters.">hal_subregister_write</a>(<a class="code" href="a00763.html#a3517409068f4c36eedae73ed8ffead13" title="Access parameters for sub-register CLKM_SHA_SEL in register RG_TRX_CTRL_0.">SR_CLKM_SHA_SEL</a>, 0);
<a name="l00644"></a>00644     }
<a name="l00645"></a>00645         
<a name="l00646"></a>00646         <a class="code" href="a01709.html#ga3577f9187e7d5af04be3fd1377307ffa" title="This function writes a new value to one of the radio transceiver&#39;s subregisters.">hal_subregister_write</a>(<a class="code" href="a00763.html#ac108f260911d536daba845f79a0c7eff" title="Access parameters for sub-register CLKM_CTRL in register RG_TRX_CTRL_0.">SR_CLKM_CTRL</a>, clock_speed);
<a name="l00647"></a>00647 
<a name="l00648"></a>00648     <span class="keywordflow">return</span> <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ae0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l00649"></a>00649 }
<a name="l00650"></a>00650 
<a name="l00651"></a>00651 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00652"></a>00652 <span class="comment">/** \brief  This function calibrates the Single Side Band Filter.</span>
<a name="l00653"></a>00653 <span class="comment"> *</span>
<a name="l00654"></a>00654 <span class="comment"> *  \retval     RADIO_SUCCESS    Filter is calibrated.</span>
<a name="l00655"></a>00655 <span class="comment"> *  \retval     RADIO_TIMED_OUT  The calibration could not be completed within time.</span>
<a name="l00656"></a>00656 <span class="comment"> *  \retval     RADIO_WRONG_STATE This function can only be called from TRX_OFF or</span>
<a name="l00657"></a>00657 <span class="comment"> *              PLL_ON.</span>
<a name="l00658"></a>00658 <span class="comment"> */</span>
<a name="l00659"></a>00659 <a class="code" href="a01710.html#gab6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a>
<a name="l00660"></a><a class="code" href="a01710.html#ga2158bddd81b0f0c610e2ef3ae371b2f4">00660</a> <a class="code" href="a01710.html#ga2158bddd81b0f0c610e2ef3ae371b2f4" title="This function calibrates the Single Side Band Filter.">radio_calibrate_filter</a>(<span class="keywordtype">void</span>)
<a name="l00661"></a>00661 {
<a name="l00662"></a>00662     <span class="comment">/*Check current state. Only possible to do filter calibration from TRX_OFF or PLL_ON.*/</span>
<a name="l00663"></a>00663     uint8_t trx_state = <a class="code" href="a01710.html#ga8e301ea5e85cf022a857a892f98b4a62" title="This function return the Radio Transceivers current state.">radio_get_trx_state</a>();
<a name="l00664"></a>00664 
<a name="l00665"></a>00665     <span class="keywordflow">if</span> ((trx_state != <a class="code" href="a00763.html#ad9aff3d987888b9d1bcb9fc12d2c996e" title="Constant TRX_OFF for sub-register SR_TRX_STATUS.">TRX_OFF</a>) &amp;&amp;
<a name="l00666"></a>00666         (trx_state != <a class="code" href="a00763.html#a77a32ac338596fe95ea09d7603d7c295" title="Constant PLL_ON for sub-register SR_TRX_STATUS.">PLL_ON</a>)){
<a name="l00667"></a>00667         <span class="keywordflow">return</span> <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ae2cba4f4b63e5ff3c6e3a4bbbb1358e5" title="The end-user tried to do an invalid state transition.">RADIO_WRONG_STATE</a>;
<a name="l00668"></a>00668     }
<a name="l00669"></a>00669 
<a name="l00670"></a>00670     <span class="comment">/* Start the tuning algorithm by writing one to the FTN_START subregister. */</span>
<a name="l00671"></a>00671     <a class="code" href="a01709.html#ga3577f9187e7d5af04be3fd1377307ffa" title="This function writes a new value to one of the radio transceiver&#39;s subregisters.">hal_subregister_write</a>(<a class="code" href="a00763.html#a1a77552f46a81081a7c06ce03b855427" title="Access parameters for sub-register FTN_START in register RG_FTN_CTRL.">SR_FTN_START</a>, 1);
<a name="l00672"></a>00672     delay_us(<a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08dacbada1dc573b954bad0184f6b111c02b" title="Maximum time it should take to do the filter tuning.">TIME_FTN_TUNING</a>); <span class="comment">/* Wait for the calibration to finish. */</span>
<a name="l00673"></a>00673 
<a name="l00674"></a>00674     <a class="code" href="a01710.html#gab6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a> filter_calibration_status = <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ac1e26b7c1be4cb9607efaa1967061bd7" title="The requested service timed out.">RADIO_TIMED_OUT</a>;
<a name="l00675"></a>00675 
<a name="l00676"></a>00676     <span class="comment">/* Verify the calibration result. */</span>
<a name="l00677"></a>00677     <span class="keywordflow">if</span> (<a class="code" href="a01709.html#ga3af07027e6111b4d8798bf3b33dce065" title="This function reads the value of a specific subregister.">hal_subregister_read</a>(<a class="code" href="a00763.html#a1a77552f46a81081a7c06ce03b855427" title="Access parameters for sub-register FTN_START in register RG_FTN_CTRL.">SR_FTN_START</a>) == FTN_CALIBRATION_DONE){
<a name="l00678"></a>00678         filter_calibration_status = <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ae0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l00679"></a>00679     }
<a name="l00680"></a>00680 
<a name="l00681"></a>00681     <span class="keywordflow">return</span> filter_calibration_status;
<a name="l00682"></a>00682 }
<a name="l00683"></a>00683 
<a name="l00684"></a>00684 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00685"></a>00685 <span class="comment">/** \brief  This function calibrates the PLL.</span>
<a name="l00686"></a>00686 <span class="comment"> *</span>
<a name="l00687"></a>00687 <span class="comment"> *  \retval     RADIO_SUCCESS    PLL Center Frequency and Delay Cell is calibrated.</span>
<a name="l00688"></a>00688 <span class="comment"> *  \retval     RADIO_TIMED_OUT  The calibration could not be completed within time.</span>
<a name="l00689"></a>00689 <span class="comment"> *  \retval     RADIO_WRONG_STATE This function can only be called from PLL_ON.</span>
<a name="l00690"></a>00690 <span class="comment"> */</span>
<a name="l00691"></a>00691 <a class="code" href="a01710.html#gab6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a>
<a name="l00692"></a><a class="code" href="a01710.html#ga82ec2ae781a717e100307ac9e546fe33">00692</a> <a class="code" href="a01710.html#ga82ec2ae781a717e100307ac9e546fe33" title="This function calibrates the PLL.">radio_calibrate_pll</a>(<span class="keywordtype">void</span>)
<a name="l00693"></a>00693 {
<a name="l00694"></a>00694 
<a name="l00695"></a>00695     <span class="comment">/*Check current state. Only possible to calibrate PLL from PLL_ON state*/</span>
<a name="l00696"></a>00696     <span class="keywordflow">if</span> (<a class="code" href="a01710.html#ga8e301ea5e85cf022a857a892f98b4a62" title="This function return the Radio Transceivers current state.">radio_get_trx_state</a>() != <a class="code" href="a00763.html#a77a32ac338596fe95ea09d7603d7c295" title="Constant PLL_ON for sub-register SR_TRX_STATUS.">PLL_ON</a>){
<a name="l00697"></a>00697         <span class="keywordflow">return</span> <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ae2cba4f4b63e5ff3c6e3a4bbbb1358e5" title="The end-user tried to do an invalid state transition.">RADIO_WRONG_STATE</a>;
<a name="l00698"></a>00698     }
<a name="l00699"></a>00699 
<a name="l00700"></a>00700     <span class="comment">/* Initiate the DCU and CF calibration loops. */</span>
<a name="l00701"></a>00701     <a class="code" href="a01709.html#ga3577f9187e7d5af04be3fd1377307ffa" title="This function writes a new value to one of the radio transceiver&#39;s subregisters.">hal_subregister_write</a>(<a class="code" href="a00763.html#a9403a03b192bcd225d457872e7738a2e" title="Access parameters for sub-register PLL_DCU_START in register RG_PLL_DCU.">SR_PLL_DCU_START</a>, 1);
<a name="l00702"></a>00702     <a class="code" href="a01709.html#ga3577f9187e7d5af04be3fd1377307ffa" title="This function writes a new value to one of the radio transceiver&#39;s subregisters.">hal_subregister_write</a>(<a class="code" href="a00763.html#ad0563f355d208198921545ec804038eb" title="Access parameters for sub-register PLL_CF_START in register RG_PLL_CF.">SR_PLL_CF_START</a>, 1);
<a name="l00703"></a>00703 
<a name="l00704"></a>00704     <span class="comment">/* Wait maximum 150 us for the PLL to lock. */</span>
<a name="l00705"></a>00705     <a class="code" href="a01709.html#gacfa3d889af78723a3664088e4e297080" title="This function clears the PLL_LOCK flag.">hal_clear_pll_lock_flag</a>();
<a name="l00706"></a>00706     delay_us(<a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08dae5b568fca41fce82055b00269565b7ef" title="Maximum time it should take for the PLL to lock.">TIME_PLL_LOCK</a>);
<a name="l00707"></a>00707 
<a name="l00708"></a>00708     <a class="code" href="a01710.html#gab6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a> pll_calibration_status = <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ac1e26b7c1be4cb9607efaa1967061bd7" title="The requested service timed out.">RADIO_TIMED_OUT</a>;
<a name="l00709"></a>00709 
<a name="l00710"></a>00710     <span class="keywordflow">if</span> (<a class="code" href="a01709.html#ga1f167a5d5756dad8d888a9fb7f6e21a3" title="This function returns the current value of the PLL_LOCK flag.">hal_get_pll_lock_flag</a>() &gt; 0){
<a name="l00711"></a>00711         <span class="keywordflow">if</span> (<a class="code" href="a01709.html#ga3af07027e6111b4d8798bf3b33dce065" title="This function reads the value of a specific subregister.">hal_subregister_read</a>(<a class="code" href="a00763.html#a9403a03b192bcd225d457872e7738a2e" title="Access parameters for sub-register PLL_DCU_START in register RG_PLL_DCU.">SR_PLL_DCU_START</a>) == PLL_DCU_CALIBRATION_DONE){
<a name="l00712"></a>00712             <span class="keywordflow">if</span> (<a class="code" href="a01709.html#ga3af07027e6111b4d8798bf3b33dce065" title="This function reads the value of a specific subregister.">hal_subregister_read</a>(<a class="code" href="a00763.html#ad0563f355d208198921545ec804038eb" title="Access parameters for sub-register PLL_CF_START in register RG_PLL_CF.">SR_PLL_CF_START</a>) == PLL_CF_CALIBRATION_DONE){
<a name="l00713"></a>00713                 pll_calibration_status = <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ae0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l00714"></a>00714             }
<a name="l00715"></a>00715         }
<a name="l00716"></a>00716     }
<a name="l00717"></a>00717 
<a name="l00718"></a>00718     <span class="keywordflow">return</span> pll_calibration_status;
<a name="l00719"></a>00719 }
<a name="l00720"></a>00720 
<a name="l00721"></a>00721 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00722"></a>00722 <span class="comment">/** \brief  This function return the Radio Transceivers current state.</span>
<a name="l00723"></a>00723 <span class="comment"> *</span>
<a name="l00724"></a>00724 <span class="comment"> *  \retval     P_ON               When the external supply voltage (VDD) is</span>
<a name="l00725"></a>00725 <span class="comment"> *                                 first supplied to the transceiver IC, the</span>
<a name="l00726"></a>00726 <span class="comment"> *                                 system is in the P_ON (Poweron) mode.</span>
<a name="l00727"></a>00727 <span class="comment"> *  \retval     BUSY_RX            The radio transceiver is busy receiving a</span>
<a name="l00728"></a>00728 <span class="comment"> *                                 frame.</span>
<a name="l00729"></a>00729 <span class="comment"> *  \retval     BUSY_TX            The radio transceiver is busy transmitting a</span>
<a name="l00730"></a>00730 <span class="comment"> *                                 frame.</span>
<a name="l00731"></a>00731 <span class="comment"> *  \retval     RX_ON              The RX_ON mode enables the analog and digital</span>
<a name="l00732"></a>00732 <span class="comment"> *                                 receiver blocks and the PLL frequency</span>
<a name="l00733"></a>00733 <span class="comment"> *                                 synthesizer.</span>
<a name="l00734"></a>00734 <span class="comment"> *  \retval     TRX_OFF            In this mode, the SPI module and crystal</span>
<a name="l00735"></a>00735 <span class="comment"> *                                 oscillator are active.</span>
<a name="l00736"></a>00736 <span class="comment"> *  \retval     PLL_ON             Entering the PLL_ON mode from TRX_OFF will</span>
<a name="l00737"></a>00737 <span class="comment"> *                                 first enable the analog voltage regulator. The</span>
<a name="l00738"></a>00738 <span class="comment"> *                                 transceiver is ready to transmit a frame.</span>
<a name="l00739"></a>00739 <span class="comment"> *  \retval     BUSY_RX_AACK       The radio was in RX_AACK_ON mode and received</span>
<a name="l00740"></a>00740 <span class="comment"> *                                 the Start of Frame Delimiter (SFD). State</span>
<a name="l00741"></a>00741 <span class="comment"> *                                 transition to BUSY_RX_AACK is done if the SFD</span>
<a name="l00742"></a>00742 <span class="comment"> *                                 is valid.</span>
<a name="l00743"></a>00743 <span class="comment"> *  \retval     BUSY_TX_ARET       The radio transceiver is busy handling the</span>
<a name="l00744"></a>00744 <span class="comment"> *                                 auto retry mechanism.</span>
<a name="l00745"></a>00745 <span class="comment"> *  \retval     RX_AACK_ON         The auto acknowledge mode of the radio is</span>
<a name="l00746"></a>00746 <span class="comment"> *                                 enabled and it is waiting for an incomming</span>
<a name="l00747"></a>00747 <span class="comment"> *                                 frame.</span>
<a name="l00748"></a>00748 <span class="comment"> *  \retval     TX_ARET_ON         The auto retry mechanism is enabled and the</span>
<a name="l00749"></a>00749 <span class="comment"> *                                 radio transceiver is waiting for the user to</span>
<a name="l00750"></a>00750 <span class="comment"> *                                 send the TX_START command.</span>
<a name="l00751"></a>00751 <span class="comment"> *  \retval     RX_ON_NOCLK        The radio transceiver is listening for</span>
<a name="l00752"></a>00752 <span class="comment"> *                                 incomming frames, but the CLKM is disabled so</span>
<a name="l00753"></a>00753 <span class="comment"> *                                 that the controller could be sleeping.</span>
<a name="l00754"></a>00754 <span class="comment"> *                                 However, this is only true if the controller</span>
<a name="l00755"></a>00755 <span class="comment"> *                                 is run from the clock output of the radio.</span>
<a name="l00756"></a>00756 <span class="comment"> *  \retval     RX_AACK_ON_NOCLK   Same as the RX_ON_NOCLK state, but with the</span>
<a name="l00757"></a>00757 <span class="comment"> *                                 auto acknowledge module turned on.</span>
<a name="l00758"></a>00758 <span class="comment"> *  \retval     BUSY_RX_AACK_NOCLK Same as BUSY_RX_AACK, but the controller</span>
<a name="l00759"></a>00759 <span class="comment"> *                                 could be sleeping since the CLKM pin is</span>
<a name="l00760"></a>00760 <span class="comment"> *                                 disabled.</span>
<a name="l00761"></a>00761 <span class="comment"> *  \retval     STATE_TRANSITION   The radio transceiver&#39;s state machine is in</span>
<a name="l00762"></a>00762 <span class="comment"> *                                 transition between two states.</span>
<a name="l00763"></a>00763 <span class="comment"> */</span>
<a name="l00764"></a>00764 uint8_t
<a name="l00765"></a><a class="code" href="a01710.html#ga8e301ea5e85cf022a857a892f98b4a62">00765</a> <a class="code" href="a01710.html#ga8e301ea5e85cf022a857a892f98b4a62" title="This function return the Radio Transceivers current state.">radio_get_trx_state</a>(<span class="keywordtype">void</span>)
<a name="l00766"></a>00766 {
<a name="l00767"></a>00767     <span class="keywordflow">return</span> <a class="code" href="a01709.html#ga3af07027e6111b4d8798bf3b33dce065" title="This function reads the value of a specific subregister.">hal_subregister_read</a>(<a class="code" href="a00763.html#abb9dcc6f85b1154d76645b5de64d4835" title="Access parameters for sub-register TRX_STATUS in register RG_TRX_STATUS.">SR_TRX_STATUS</a>);
<a name="l00768"></a>00768 }
<a name="l00769"></a>00769 
<a name="l00770"></a>00770 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00771"></a>00771 <span class="comment">/** \brief  This function checks if the radio transceiver is sleeping.</span>
<a name="l00772"></a>00772 <span class="comment"> *</span>
<a name="l00773"></a>00773 <span class="comment"> *  \retval     true    The radio transceiver is in SLEEP or one of the *_NOCLK</span>
<a name="l00774"></a>00774 <span class="comment"> *                      states.</span>
<a name="l00775"></a>00775 <span class="comment"> *  \retval     false   The radio transceiver is not sleeping.</span>
<a name="l00776"></a>00776 <span class="comment"> */</span>
<a name="l00777"></a><a class="code" href="a01710.html#ga7c4b1fbd30174589d1a0660f30a543e3">00777</a> <span class="keywordtype">bool</span> <a class="code" href="a01710.html#ga7c4b1fbd30174589d1a0660f30a543e3" title="This function checks if the radio transceiver is sleeping.">radio_is_sleeping</a>(<span class="keywordtype">void</span>)
<a name="l00778"></a>00778 {
<a name="l00779"></a>00779     <span class="keywordtype">bool</span> sleeping = <span class="keyword">false</span>;
<a name="l00780"></a>00780 
<a name="l00781"></a>00781     <span class="comment">/* The radio transceiver will be at SLEEP or one of the *_NOCLK states only if */</span>
<a name="l00782"></a>00782     <span class="comment">/* the SLP_TR pin is high. */</span>
<a name="l00783"></a>00783     <span class="keywordflow">if</span> (<a class="code" href="a01709.html#gaf84d2cf7ef1ceb94be57bc20be328cea" title="Read current state of the SLP_TR pin (High/Low).">hal_get_slptr</a>() != 0){
<a name="l00784"></a>00784         sleeping = <span class="keyword">true</span>;
<a name="l00785"></a>00785     }
<a name="l00786"></a>00786 
<a name="l00787"></a>00787     <span class="keywordflow">return</span> sleeping;
<a name="l00788"></a>00788 }
<a name="l00789"></a>00789 
<a name="l00790"></a>00790 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00791"></a>00791 <span class="comment">/** \brief  This function will change the current state of the radio</span>
<a name="l00792"></a>00792 <span class="comment"> *          transceiver&#39;s internal state machine.</span>
<a name="l00793"></a>00793 <span class="comment"> *</span>
<a name="l00794"></a>00794 <span class="comment"> *  \param     new_state        Here is a list of possible states:</span>
<a name="l00795"></a>00795 <span class="comment"> *             - RX_ON        Requested transition to RX_ON state.</span>
<a name="l00796"></a>00796 <span class="comment"> *             - TRX_OFF      Requested transition to TRX_OFF state.</span>
<a name="l00797"></a>00797 <span class="comment"> *             - PLL_ON       Requested transition to PLL_ON state.</span>
<a name="l00798"></a>00798 <span class="comment"> *             - RX_AACK_ON   Requested transition to RX_AACK_ON state.</span>
<a name="l00799"></a>00799 <span class="comment"> *             - TX_ARET_ON   Requested transition to TX_ARET_ON state.</span>
<a name="l00800"></a>00800 <span class="comment"> *</span>
<a name="l00801"></a>00801 <span class="comment"> *  \retval    RADIO_SUCCESS          Requested state transition completed</span>
<a name="l00802"></a>00802 <span class="comment"> *                                  successfully.</span>
<a name="l00803"></a>00803 <span class="comment"> *  \retval    RADIO_INVALID_ARGUMENT Supplied function parameter out of bounds.</span>
<a name="l00804"></a>00804 <span class="comment"> *  \retval    RADIO_WRONG_STATE      Illegal state to do transition from.</span>
<a name="l00805"></a>00805 <span class="comment"> *  \retval    RADIO_BUSY_STATE       The radio transceiver is busy.</span>
<a name="l00806"></a>00806 <span class="comment"> *  \retval    RADIO_TIMED_OUT        The state transition could not be completed</span>
<a name="l00807"></a>00807 <span class="comment"> *                                  within resonable time.</span>
<a name="l00808"></a>00808 <span class="comment"> */</span>
<a name="l00809"></a>00809 <a class="code" href="a01710.html#gab6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a>
<a name="l00810"></a><a class="code" href="a01710.html#ga06b43a13b2efd1a4e0c1b9ae7a204c81">00810</a> <a class="code" href="a01710.html#ga06b43a13b2efd1a4e0c1b9ae7a204c81" title="This function will change the current state of the radio transceiver&#39;s internal state machine...">radio_set_trx_state</a>(uint8_t new_state)
<a name="l00811"></a>00811 {
<a name="l00812"></a>00812     uint8_t original_state;
<a name="l00813"></a>00813 
<a name="l00814"></a>00814     <span class="comment">/*Check function paramter and current state of the radio transceiver.*/</span>
<a name="l00815"></a>00815     <span class="keywordflow">if</span> (!((new_state == <a class="code" href="a00763.html#ad9aff3d987888b9d1bcb9fc12d2c996e" title="Constant TRX_OFF for sub-register SR_TRX_STATUS.">TRX_OFF</a>)    ||
<a name="l00816"></a>00816           (new_state == <a class="code" href="a00763.html#a359db88bcffa6b39bdb64ec00ec3a1ae" title="Constant RX_ON for sub-register SR_TRX_STATUS.">RX_ON</a>)      ||
<a name="l00817"></a>00817           (new_state == <a class="code" href="a00763.html#a77a32ac338596fe95ea09d7603d7c295" title="Constant PLL_ON for sub-register SR_TRX_STATUS.">PLL_ON</a>)     ||
<a name="l00818"></a>00818           (new_state == <a class="code" href="a00763.html#afddeaef97c7252f303f60355d79bf04c" title="Constant RX_AACK_ON for sub-register SR_TRX_STATUS.">RX_AACK_ON</a>) ||
<a name="l00819"></a>00819           (new_state == <a class="code" href="a00763.html#a0d659f730692556a1b5e68f54c8ae015" title="Constant TX_ARET_ON for sub-register SR_TRX_STATUS.">TX_ARET_ON</a>))){
<a name="l00820"></a>00820         <span class="keywordflow">return</span> <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73a9dc11f55b8f5a813e72002eb36710389" title="One or more of the supplied function arguments are invalid.">RADIO_INVALID_ARGUMENT</a>;
<a name="l00821"></a>00821     }
<a name="l00822"></a>00822 
<a name="l00823"></a>00823     <span class="keywordflow">if</span> (<a class="code" href="a01710.html#ga7c4b1fbd30174589d1a0660f30a543e3" title="This function checks if the radio transceiver is sleeping.">radio_is_sleeping</a>() == <span class="keyword">true</span>){
<a name="l00824"></a>00824         <span class="keywordflow">return</span> <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ae2cba4f4b63e5ff3c6e3a4bbbb1358e5" title="The end-user tried to do an invalid state transition.">RADIO_WRONG_STATE</a>;
<a name="l00825"></a>00825     }
<a name="l00826"></a>00826 
<a name="l00827"></a>00827     <span class="comment">// Wait for radio to finish previous operation</span>
<a name="l00828"></a>00828     <span class="keywordflow">for</span>(;;)
<a name="l00829"></a>00829     {
<a name="l00830"></a>00830         original_state = <a class="code" href="a01710.html#ga8e301ea5e85cf022a857a892f98b4a62" title="This function return the Radio Transceivers current state.">radio_get_trx_state</a>();
<a name="l00831"></a>00831         <span class="keywordflow">if</span> (original_state != <a class="code" href="a00763.html#a4480cfa57a0f162471e351fce3ce72da" title="Constant BUSY_TX_ARET for sub-register SR_TRX_STATUS.">BUSY_TX_ARET</a> &amp;&amp;
<a name="l00832"></a>00832             original_state != <a class="code" href="a00763.html#ab128af01291fb016509cce7df4de6233" title="Constant BUSY_RX_AACK for sub-register SR_TRX_STATUS.">BUSY_RX_AACK</a> &amp;&amp;
<a name="l00833"></a>00833             original_state != <a class="code" href="a00763.html#a9486d08d26658473840dd55ef9d59783" title="Constant BUSY_RX for sub-register SR_TRX_STATUS.">BUSY_RX</a> &amp;&amp; 
<a name="l00834"></a>00834             original_state != <a class="code" href="a00763.html#a9cbdb413702bfd45c35773bee53c4cd3" title="Constant BUSY_TX for sub-register SR_TRX_STATUS.">BUSY_TX</a>)
<a name="l00835"></a>00835             <span class="keywordflow">break</span>;
<a name="l00836"></a>00836     }
<a name="l00837"></a>00837 
<a name="l00838"></a>00838     <span class="keywordflow">if</span> (new_state == original_state){
<a name="l00839"></a>00839         <span class="keywordflow">return</span> <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ae0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l00840"></a>00840     }
<a name="l00841"></a>00841 
<a name="l00842"></a>00842 
<a name="l00843"></a>00843     <span class="comment">/* At this point it is clear that the requested new_state is: */</span>
<a name="l00844"></a>00844     <span class="comment">/* TRX_OFF, RX_ON, PLL_ON, RX_AACK_ON or TX_ARET_ON. */</span>
<a name="l00845"></a>00845 
<a name="l00846"></a>00846     <span class="comment">/* The radio transceiver can be in one of the following states: */</span>
<a name="l00847"></a>00847     <span class="comment">/* TRX_OFF, RX_ON, PLL_ON, RX_AACK_ON, TX_ARET_ON. */</span>
<a name="l00848"></a>00848     <span class="keywordflow">if</span>(new_state == <a class="code" href="a00763.html#ad9aff3d987888b9d1bcb9fc12d2c996e" title="Constant TRX_OFF for sub-register SR_TRX_STATUS.">TRX_OFF</a>){
<a name="l00849"></a>00849         <a class="code" href="a01710.html#gaa52f656bbbbd56a2935b9a54d55717d4" title="This function will reset the state machine (to TRX_OFF) from any of its states, except for the SLEEP ...">radio_reset_state_machine</a>(); <span class="comment">/* Go to TRX_OFF from any state. */</span>
<a name="l00850"></a>00850     } <span class="keywordflow">else</span> {
<a name="l00851"></a>00851         <span class="comment">/* It is not allowed to go from RX_AACK_ON or TX_AACK_ON and directly to */</span>
<a name="l00852"></a>00852         <span class="comment">/* TX_AACK_ON or RX_AACK_ON respectively. Need to go via RX_ON or PLL_ON. */</span>
<a name="l00853"></a>00853         <span class="keywordflow">if</span> ((new_state == <a class="code" href="a00763.html#a0d659f730692556a1b5e68f54c8ae015" title="Constant TX_ARET_ON for sub-register SR_TRX_STATUS.">TX_ARET_ON</a>) &amp;&amp;
<a name="l00854"></a>00854             (original_state == <a class="code" href="a00763.html#afddeaef97c7252f303f60355d79bf04c" title="Constant RX_AACK_ON for sub-register SR_TRX_STATUS.">RX_AACK_ON</a>)){
<a name="l00855"></a>00855             <span class="comment">/* First do intermediate state transition to PLL_ON, then to TX_ARET_ON. */</span>
<a name="l00856"></a>00856             <span class="comment">/* The final state transition to TX_ARET_ON is handled after the if-else if. */</span>
<a name="l00857"></a>00857             <a class="code" href="a01709.html#ga3577f9187e7d5af04be3fd1377307ffa" title="This function writes a new value to one of the radio transceiver&#39;s subregisters.">hal_subregister_write</a>(<a class="code" href="a00763.html#a8d912618842812f37fc46356eff73c93" title="Access parameters for sub-register TRX_CMD in register RG_TRX_STATE.">SR_TRX_CMD</a>, <a class="code" href="a00763.html#a77a32ac338596fe95ea09d7603d7c295" title="Constant PLL_ON for sub-register SR_TRX_STATUS.">PLL_ON</a>);
<a name="l00858"></a>00858             delay_us(<a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08daa68a9b1ecf13ab8095e32d86d35d416b" title="Transition time from PLL active state to another.">TIME_STATE_TRANSITION_PLL_ACTIVE</a>);
<a name="l00859"></a>00859         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((new_state == <a class="code" href="a00763.html#afddeaef97c7252f303f60355d79bf04c" title="Constant RX_AACK_ON for sub-register SR_TRX_STATUS.">RX_AACK_ON</a>) &amp;&amp;
<a name="l00860"></a>00860                  (original_state == <a class="code" href="a00763.html#a0d659f730692556a1b5e68f54c8ae015" title="Constant TX_ARET_ON for sub-register SR_TRX_STATUS.">TX_ARET_ON</a>)){
<a name="l00861"></a>00861             <span class="comment">/* First do intermediate state transition to RX_ON, then to RX_AACK_ON. */</span>
<a name="l00862"></a>00862             <span class="comment">/* The final state transition to RX_AACK_ON is handled after the if-else if. */</span>
<a name="l00863"></a>00863             <a class="code" href="a01709.html#ga3577f9187e7d5af04be3fd1377307ffa" title="This function writes a new value to one of the radio transceiver&#39;s subregisters.">hal_subregister_write</a>(<a class="code" href="a00763.html#a8d912618842812f37fc46356eff73c93" title="Access parameters for sub-register TRX_CMD in register RG_TRX_STATE.">SR_TRX_CMD</a>, <a class="code" href="a00763.html#a359db88bcffa6b39bdb64ec00ec3a1ae" title="Constant RX_ON for sub-register SR_TRX_STATUS.">RX_ON</a>);
<a name="l00864"></a>00864             delay_us(<a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08daa68a9b1ecf13ab8095e32d86d35d416b" title="Transition time from PLL active state to another.">TIME_STATE_TRANSITION_PLL_ACTIVE</a>);
<a name="l00865"></a>00865         }
<a name="l00866"></a>00866 
<a name="l00867"></a>00867         <span class="comment">/* Any other state transition can be done directly. */</span>
<a name="l00868"></a>00868         <a class="code" href="a01709.html#ga3577f9187e7d5af04be3fd1377307ffa" title="This function writes a new value to one of the radio transceiver&#39;s subregisters.">hal_subregister_write</a>(<a class="code" href="a00763.html#a8d912618842812f37fc46356eff73c93" title="Access parameters for sub-register TRX_CMD in register RG_TRX_STATE.">SR_TRX_CMD</a>, new_state);
<a name="l00869"></a>00869 
<a name="l00870"></a>00870         <span class="comment">/* When the PLL is active most states can be reached in 1us. However, from */</span>
<a name="l00871"></a>00871         <span class="comment">/* TRX_OFF the PLL needs time to activate. */</span>
<a name="l00872"></a>00872         <span class="keywordflow">if</span> (original_state == <a class="code" href="a00763.html#ad9aff3d987888b9d1bcb9fc12d2c996e" title="Constant TRX_OFF for sub-register SR_TRX_STATUS.">TRX_OFF</a>){
<a name="l00873"></a>00873             delay_us(<a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08dab69e9ed03883d6e427ea2027fb3daf13" title="Transition time from TRX_OFF to: RX_ON, PLL_ON, TX_ARET_ON and RX_AACK_ON.">TIME_TRX_OFF_TO_PLL_ACTIVE</a>);
<a name="l00874"></a>00874         } <span class="keywordflow">else</span> {
<a name="l00875"></a>00875             delay_us(<a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08daa68a9b1ecf13ab8095e32d86d35d416b" title="Transition time from PLL active state to another.">TIME_STATE_TRANSITION_PLL_ACTIVE</a>);
<a name="l00876"></a>00876         }
<a name="l00877"></a>00877     } <span class="comment">/*  end: if(new_state == TRX_OFF) ... */</span>
<a name="l00878"></a>00878 
<a name="l00879"></a>00879     <span class="comment">/*Verify state transition.*/</span>
<a name="l00880"></a>00880     <a class="code" href="a01710.html#gab6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a> set_state_status = <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ac1e26b7c1be4cb9607efaa1967061bd7" title="The requested service timed out.">RADIO_TIMED_OUT</a>;
<a name="l00881"></a>00881 
<a name="l00882"></a>00882     <span class="keywordflow">if</span> (<a class="code" href="a01710.html#ga8e301ea5e85cf022a857a892f98b4a62" title="This function return the Radio Transceivers current state.">radio_get_trx_state</a>() == new_state){
<a name="l00883"></a>00883         set_state_status = <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ae0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l00884"></a>00884         <span class="comment">/*  set rx_mode flag based on mode we&#39;re changing to */</span>
<a name="l00885"></a>00885         <span class="keywordflow">if</span> (new_state == <a class="code" href="a00763.html#a359db88bcffa6b39bdb64ec00ec3a1ae" title="Constant RX_ON for sub-register SR_TRX_STATUS.">RX_ON</a> ||
<a name="l00886"></a>00886             new_state == <a class="code" href="a00763.html#afddeaef97c7252f303f60355d79bf04c" title="Constant RX_AACK_ON for sub-register SR_TRX_STATUS.">RX_AACK_ON</a>){
<a name="l00887"></a>00887             rx_mode = <span class="keyword">true</span>;
<a name="l00888"></a>00888         } <span class="keywordflow">else</span> {
<a name="l00889"></a>00889             rx_mode = <span class="keyword">false</span>;
<a name="l00890"></a>00890     }
<a name="l00891"></a>00891     }
<a name="l00892"></a>00892 
<a name="l00893"></a>00893     <span class="keywordflow">return</span> set_state_status;
<a name="l00894"></a>00894 }
<a name="l00895"></a>00895 
<a name="l00896"></a>00896 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00897"></a>00897 <span class="comment">/** \brief  This function will put the radio transceiver to sleep.</span>
<a name="l00898"></a>00898 <span class="comment"> *</span>
<a name="l00899"></a>00899 <span class="comment"> *  \retval    RADIO_SUCCESS          Sleep mode entered successfully.</span>
<a name="l00900"></a>00900 <span class="comment"> *  \retval    RADIO_TIMED_OUT        The transition to TRX_OFF took too long.</span>
<a name="l00901"></a>00901 <span class="comment"> */</span>
<a name="l00902"></a>00902 <a class="code" href="a01710.html#gab6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a>
<a name="l00903"></a><a class="code" href="a01710.html#ga94b281d32e42539a85cda615f92d1fed">00903</a> <a class="code" href="a01710.html#ga94b281d32e42539a85cda615f92d1fed" title="This function will put the radio transceiver to sleep.">radio_enter_sleep_mode</a>(<span class="keywordtype">void</span>)
<a name="l00904"></a>00904 {
<a name="l00905"></a>00905     <span class="keywordflow">if</span> (<a class="code" href="a01710.html#ga7c4b1fbd30174589d1a0660f30a543e3" title="This function checks if the radio transceiver is sleeping.">radio_is_sleeping</a>() == <span class="keyword">true</span>){
<a name="l00906"></a>00906         <span class="keywordflow">return</span> <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ae0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l00907"></a>00907     }
<a name="l00908"></a>00908 
<a name="l00909"></a>00909     <a class="code" href="a01710.html#gaa52f656bbbbd56a2935b9a54d55717d4" title="This function will reset the state machine (to TRX_OFF) from any of its states, except for the SLEEP ...">radio_reset_state_machine</a>(); <span class="comment">/* Force the device into TRX_OFF. */</span>
<a name="l00910"></a>00910 
<a name="l00911"></a>00911     <a class="code" href="a01710.html#gab6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a> enter_sleep_status = <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ac1e26b7c1be4cb9607efaa1967061bd7" title="The requested service timed out.">RADIO_TIMED_OUT</a>;
<a name="l00912"></a>00912 
<a name="l00913"></a>00913     <span class="keywordflow">if</span> (<a class="code" href="a01710.html#ga8e301ea5e85cf022a857a892f98b4a62" title="This function return the Radio Transceivers current state.">radio_get_trx_state</a>() == <a class="code" href="a00763.html#ad9aff3d987888b9d1bcb9fc12d2c996e" title="Constant TRX_OFF for sub-register SR_TRX_STATUS.">TRX_OFF</a>){
<a name="l00914"></a>00914         <span class="comment">/* Enter Sleep. */</span>
<a name="l00915"></a>00915         <a class="code" href="a01709.html#ga3187ed11240408b228dcaedd46f8793d" title="This macro pulls the SLP_TR pin high.">hal_set_slptr_high</a>();
<a name="l00916"></a>00916         enter_sleep_status = <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ae0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l00917"></a>00917 <span class="preprocessor">#if RADIOSTATS</span>
<a name="l00918"></a>00918 <span class="preprocessor"></span>        RF230_radio_on = 0;
<a name="l00919"></a>00919 <span class="preprocessor">#endif</span>
<a name="l00920"></a>00920 <span class="preprocessor"></span>    }
<a name="l00921"></a>00921 
<a name="l00922"></a>00922     <span class="keywordflow">return</span> enter_sleep_status;
<a name="l00923"></a>00923 }
<a name="l00924"></a>00924 
<a name="l00925"></a>00925 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00926"></a>00926 <span class="comment">/** \brief  This function will take the radio transceiver from sleep mode and</span>
<a name="l00927"></a>00927 <span class="comment"> *          put it into the TRX_OFF state.</span>
<a name="l00928"></a>00928 <span class="comment"> *</span>
<a name="l00929"></a>00929 <span class="comment"> *  \retval    RADIO_SUCCESS          Left sleep mode and entered TRX_OFF state.</span>
<a name="l00930"></a>00930 <span class="comment"> *  \retval    RADIO_TIMED_OUT        Transition to TRX_OFF state timed out.</span>
<a name="l00931"></a>00931 <span class="comment"> */</span>
<a name="l00932"></a>00932 <a class="code" href="a01710.html#gab6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a>
<a name="l00933"></a><a class="code" href="a01710.html#ga66185e391cb6c0650805502a8c2dab68">00933</a> <a class="code" href="a01710.html#ga66185e391cb6c0650805502a8c2dab68" title="This function will take the radio transceiver from sleep mode and put it into the TRX_OFF state...">radio_leave_sleep_mode</a>(<span class="keywordtype">void</span>)
<a name="l00934"></a>00934 {
<a name="l00935"></a>00935     <span class="comment">/* Check if the radio transceiver is actually sleeping. */</span>
<a name="l00936"></a>00936     <span class="keywordflow">if</span> (<a class="code" href="a01710.html#ga7c4b1fbd30174589d1a0660f30a543e3" title="This function checks if the radio transceiver is sleeping.">radio_is_sleeping</a>() == <span class="keyword">false</span>){
<a name="l00937"></a>00937         <span class="keywordflow">return</span> <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ae0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l00938"></a>00938     }
<a name="l00939"></a>00939 
<a name="l00940"></a>00940     <a class="code" href="a01709.html#ga8ceacb61f5cbdcac765a6b9bbab8c3ca" title="This macro pulls the SLP_TR pin low.">hal_set_slptr_low</a>();
<a name="l00941"></a>00941     delay_us(<a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08da7067e6c59db93ac323c375140eff1c51" title="Transition time from SLEEP to TRX_OFF.">TIME_SLEEP_TO_TRX_OFF</a>);
<a name="l00942"></a>00942 
<a name="l00943"></a>00943     <a class="code" href="a01710.html#gab6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a> leave_sleep_status = <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ac1e26b7c1be4cb9607efaa1967061bd7" title="The requested service timed out.">RADIO_TIMED_OUT</a>;
<a name="l00944"></a>00944 
<a name="l00945"></a>00945     <span class="comment">/* Ensure that the radio transceiver is in the TRX_OFF state. */</span>
<a name="l00946"></a>00946     <span class="keywordflow">if</span> (<a class="code" href="a01710.html#ga8e301ea5e85cf022a857a892f98b4a62" title="This function return the Radio Transceivers current state.">radio_get_trx_state</a>() == <a class="code" href="a00763.html#ad9aff3d987888b9d1bcb9fc12d2c996e" title="Constant TRX_OFF for sub-register SR_TRX_STATUS.">TRX_OFF</a>){
<a name="l00947"></a>00947         leave_sleep_status = <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ae0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l00948"></a>00948 <span class="preprocessor">#if RADIOSTATS</span>
<a name="l00949"></a>00949 <span class="preprocessor"></span>        RF230_radio_on = 1;
<a name="l00950"></a>00950 <span class="preprocessor">#endif</span>
<a name="l00951"></a>00951 <span class="preprocessor"></span>    }
<a name="l00952"></a>00952 
<a name="l00953"></a>00953     <span class="keywordflow">return</span> leave_sleep_status;
<a name="l00954"></a>00954 }
<a name="l00955"></a>00955 
<a name="l00956"></a>00956 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00957"></a>00957 <span class="comment">/** \brief  This function will reset the state machine (to TRX_OFF) from any of</span>
<a name="l00958"></a>00958 <span class="comment"> *          its states, except for the SLEEP state.</span>
<a name="l00959"></a>00959 <span class="comment"> */</span>
<a name="l00960"></a>00960 <span class="keywordtype">void</span>
<a name="l00961"></a><a class="code" href="a01710.html#gaa52f656bbbbd56a2935b9a54d55717d4">00961</a> <a class="code" href="a01710.html#gaa52f656bbbbd56a2935b9a54d55717d4" title="This function will reset the state machine (to TRX_OFF) from any of its states, except for the SLEEP ...">radio_reset_state_machine</a>(<span class="keywordtype">void</span>)
<a name="l00962"></a>00962 {
<a name="l00963"></a>00963     <a class="code" href="a01709.html#ga8ceacb61f5cbdcac765a6b9bbab8c3ca" title="This macro pulls the SLP_TR pin low.">hal_set_slptr_low</a>();
<a name="l00964"></a>00964     delay_us(<a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08da60b95807cc5d2690b9ee459c861c6a6c" title="Transition time from *_NOCLK to being awake.">TIME_NOCLK_TO_WAKE</a>);
<a name="l00965"></a>00965     <a class="code" href="a01709.html#ga3577f9187e7d5af04be3fd1377307ffa" title="This function writes a new value to one of the radio transceiver&#39;s subregisters.">hal_subregister_write</a>(<a class="code" href="a00763.html#a8d912618842812f37fc46356eff73c93" title="Access parameters for sub-register TRX_CMD in register RG_TRX_STATE.">SR_TRX_CMD</a>, <a class="code" href="a00763.html#a8ecc63755abb125691b00426cba7fe41" title="Constant CMD_FORCE_TRX_OFF for sub-register SR_TRX_CMD.">CMD_FORCE_TRX_OFF</a>);
<a name="l00966"></a>00966     delay_us(<a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08daf50b81813c269484256d8d02b3751b4f" title="Time it takes to execute the FORCE_TRX_OFF command.">TIME_CMD_FORCE_TRX_OFF</a>);
<a name="l00967"></a>00967 }
<a name="l00968"></a>00968 
<a name="l00969"></a>00969 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00970"></a>00970 <span class="comment">/** \brief  This function will reset all the registers and the state machine of</span>
<a name="l00971"></a>00971 <span class="comment"> *          the radio transceiver.</span>
<a name="l00972"></a>00972 <span class="comment"> */</span>
<a name="l00973"></a>00973 <span class="keywordtype">void</span>
<a name="l00974"></a><a class="code" href="a01710.html#ga54684d521cdfbb1f049443846c73f10f">00974</a> <a class="code" href="a01710.html#ga54684d521cdfbb1f049443846c73f10f" title="This function will reset all the registers and the state machine of the radio transceiver.">radio_reset_trx</a>(<span class="keywordtype">void</span>)
<a name="l00975"></a>00975 {
<a name="l00976"></a>00976     <a class="code" href="a01709.html#gaa5044a550f2864bffafc79059e0462a5" title="This macro pulls the RST pin low.">hal_set_rst_low</a>();
<a name="l00977"></a>00977     <a class="code" href="a01709.html#ga8ceacb61f5cbdcac765a6b9bbab8c3ca" title="This macro pulls the SLP_TR pin low.">hal_set_slptr_low</a>();
<a name="l00978"></a>00978     delay_us(<a class="code" href="a01710.html#ga7107f1e1a5e3b33325b5f7a489edb08da7987806807cc7ffc8afcafe42665af0f" title="Time to hold the RST pin low during reset.">TIME_RESET</a>);
<a name="l00979"></a>00979     <a class="code" href="a01709.html#gafad48edf9109099d92e884cc5456ac9e" title="This macro pulls the RST pin high.">hal_set_rst_high</a>();
<a name="l00980"></a>00980 }
<a name="l00981"></a>00981 
<a name="l00982"></a>00982 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l00983"></a>00983 <span class="comment">/** \brief  This function will enable or disable automatic CRC during frame</span>
<a name="l00984"></a>00984 <span class="comment"> *          transmission.</span>
<a name="l00985"></a>00985 <span class="comment"> *</span>
<a name="l00986"></a>00986 <span class="comment"> *  \param  auto_crc_on If this parameter equals true auto CRC will be used for</span>
<a name="l00987"></a>00987 <span class="comment"> *                      all frames to be transmitted. The framelength must be</span>
<a name="l00988"></a>00988 <span class="comment"> *                      increased by two bytes (16 bit CRC). If the parameter equals</span>
<a name="l00989"></a>00989 <span class="comment"> *                      false, the automatic CRC will be disabled.</span>
<a name="l00990"></a>00990 <span class="comment"> */</span>
<a name="l00991"></a>00991 <span class="keywordtype">void</span>
<a name="l00992"></a><a class="code" href="a01710.html#ga4f1b3489c8f812a5fed20e35b13cad1e">00992</a> <a class="code" href="a01710.html#ga4f1b3489c8f812a5fed20e35b13cad1e" title="This function will enable or disable automatic CRC during frame transmission.">radio_use_auto_tx_crc</a>(<span class="keywordtype">bool</span> auto_crc_on)
<a name="l00993"></a>00993 {
<a name="l00994"></a>00994     <span class="keywordflow">if</span> (auto_crc_on == <span class="keyword">true</span>){
<a name="l00995"></a>00995         <a class="code" href="a01709.html#ga3577f9187e7d5af04be3fd1377307ffa" title="This function writes a new value to one of the radio transceiver&#39;s subregisters.">hal_subregister_write</a>(<a class="code" href="a00763.html#a53420a51ab0ad2e5b108d5cbbdf6f3b6" title="Access parameters for sub-register TX_AUTO_CRC_ON in register RG_PHY_TX_PWR.">SR_TX_AUTO_CRC_ON</a>, 1);
<a name="l00996"></a>00996     } <span class="keywordflow">else</span> {
<a name="l00997"></a>00997         <a class="code" href="a01709.html#ga3577f9187e7d5af04be3fd1377307ffa" title="This function writes a new value to one of the radio transceiver&#39;s subregisters.">hal_subregister_write</a>(<a class="code" href="a00763.html#a53420a51ab0ad2e5b108d5cbbdf6f3b6" title="Access parameters for sub-register TX_AUTO_CRC_ON in register RG_PHY_TX_PWR.">SR_TX_AUTO_CRC_ON</a>, 0);
<a name="l00998"></a>00998     }
<a name="l00999"></a>00999 }
<a name="l01000"></a>01000 
<a name="l01001"></a>01001 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l01002"></a>01002 <span class="comment">/** \brief  This function will download a frame to the radio transceiver&#39;s</span>
<a name="l01003"></a>01003 <span class="comment"> *          transmit buffer and send it.</span>
<a name="l01004"></a>01004 <span class="comment"> *</span>
<a name="l01005"></a>01005 <span class="comment"> *  \param  data_length Length of the frame to be transmitted. 1 to 128 bytes are the valid lengths.</span>
<a name="l01006"></a>01006 <span class="comment"> *  \param  *data   Pointer to the data to transmit</span>
<a name="l01007"></a>01007 <span class="comment"> *</span>
<a name="l01008"></a>01008 <span class="comment"> *  \retval RADIO_SUCCESS Frame downloaded and sent successfully.</span>
<a name="l01009"></a>01009 <span class="comment"> *  \retval RADIO_INVALID_ARGUMENT If the dataLength is 0 byte or more than 127</span>
<a name="l01010"></a>01010 <span class="comment"> *                               bytes the frame will not be sent.</span>
<a name="l01011"></a>01011 <span class="comment"> *  \retval RADIO_WRONG_STATE It is only possible to use this function in the</span>
<a name="l01012"></a>01012 <span class="comment"> *                          PLL_ON and TX_ARET_ON state. If any other state is</span>
<a name="l01013"></a>01013 <span class="comment"> *                          detected this error message will be returned.</span>
<a name="l01014"></a>01014 <span class="comment"> */</span>
<a name="l01015"></a>01015 <a class="code" href="a01710.html#gab6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a>
<a name="l01016"></a><a class="code" href="a01710.html#ga63f716877b73d38e8a26e2377c57800f">01016</a> <a class="code" href="a01710.html#ga63f716877b73d38e8a26e2377c57800f" title="This function will download a frame to the radio transceiver&#39;s transmit buffer and send it...">radio_send_data</a>(uint8_t data_length, uint8_t *data)
<a name="l01017"></a>01017 {
<a name="l01018"></a>01018     <span class="comment">/*Check function parameters and current state.*/</span>
<a name="l01019"></a>01019     <span class="keywordflow">if</span> (data_length &gt; <a class="code" href="a01710.html#ga10dcfc3d2532723ff24667fcd408b012" title="127 Byte PSDU.">RF230_MAX_TX_FRAME_LENGTH</a>){
<a name="l01020"></a>01020 <span class="preprocessor">#if RADIOSTATS</span>
<a name="l01021"></a>01021 <span class="preprocessor"></span>        RF230_sendfail++;
<a name="l01022"></a>01022 <span class="preprocessor">#endif</span>
<a name="l01023"></a>01023 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73a9dc11f55b8f5a813e72002eb36710389" title="One or more of the supplied function arguments are invalid.">RADIO_INVALID_ARGUMENT</a>;
<a name="l01024"></a>01024     }
<a name="l01025"></a>01025 
<a name="l01026"></a>01026      <span class="comment">/* If we are busy, return */</span>
<a name="l01027"></a>01027         <span class="keywordflow">if</span> ((<a class="code" href="a01710.html#ga8e301ea5e85cf022a857a892f98b4a62" title="This function return the Radio Transceivers current state.">radio_get_trx_state</a>() == <a class="code" href="a00763.html#a9cbdb413702bfd45c35773bee53c4cd3" title="Constant BUSY_TX for sub-register SR_TRX_STATUS.">BUSY_TX</a>) || (<a class="code" href="a01710.html#ga8e301ea5e85cf022a857a892f98b4a62" title="This function return the Radio Transceivers current state.">radio_get_trx_state</a>() == <a class="code" href="a00763.html#a4480cfa57a0f162471e351fce3ce72da" title="Constant BUSY_TX_ARET for sub-register SR_TRX_STATUS.">BUSY_TX_ARET</a>) )
<a name="l01028"></a>01028         {
<a name="l01029"></a>01029 <span class="preprocessor">#if RADIOSTATS</span>
<a name="l01030"></a>01030 <span class="preprocessor"></span>        RF230_sendfail++;
<a name="l01031"></a>01031 <span class="preprocessor">#endif</span>
<a name="l01032"></a>01032 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ae2cba4f4b63e5ff3c6e3a4bbbb1358e5" title="The end-user tried to do an invalid state transition.">RADIO_WRONG_STATE</a>;
<a name="l01033"></a>01033         }
<a name="l01034"></a>01034 
<a name="l01035"></a>01035     <a class="code" href="a01710.html#ga06b43a13b2efd1a4e0c1b9ae7a204c81" title="This function will change the current state of the radio transceiver&#39;s internal state machine...">radio_set_trx_state</a>(<a class="code" href="a00763.html#ad9aff3d987888b9d1bcb9fc12d2c996e" title="Constant TRX_OFF for sub-register SR_TRX_STATUS.">TRX_OFF</a>);
<a name="l01036"></a>01036     <a class="code" href="a01710.html#ga06b43a13b2efd1a4e0c1b9ae7a204c81" title="This function will change the current state of the radio transceiver&#39;s internal state machine...">radio_set_trx_state</a>(<a class="code" href="a00763.html#a0d659f730692556a1b5e68f54c8ae015" title="Constant TX_ARET_ON for sub-register SR_TRX_STATUS.">TX_ARET_ON</a>);
<a name="l01037"></a>01037 
<a name="l01038"></a>01038     <span class="comment">/*Do frame transmission.*/</span>
<a name="l01039"></a>01039     <span class="comment">/* Toggle the SLP_TR pin to initiate the frame transmission. */</span>
<a name="l01040"></a>01040     <a class="code" href="a01709.html#ga3187ed11240408b228dcaedd46f8793d" title="This macro pulls the SLP_TR pin high.">hal_set_slptr_high</a>();
<a name="l01041"></a>01041     <a class="code" href="a01709.html#ga8ceacb61f5cbdcac765a6b9bbab8c3ca" title="This macro pulls the SLP_TR pin low.">hal_set_slptr_low</a>();
<a name="l01042"></a>01042 
<a name="l01043"></a>01043     <a class="code" href="a01709.html#ga67987dac2602b2c58d53d93a7c801cd1" title="This function will download a frame to the radio transceiver&#39;s frame buffer.">hal_frame_write</a>(data, data_length); <span class="comment">/* Then write data to the frame buffer. */</span>
<a name="l01044"></a>01044 <span class="preprocessor">#if RADIOSTATS</span>
<a name="l01045"></a>01045 <span class="preprocessor"></span>    RF230_sendpackets++;
<a name="l01046"></a>01046 <span class="preprocessor">#endif</span>
<a name="l01047"></a>01047 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ae0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l01048"></a>01048 }
<a name="l01049"></a>01049 
<a name="l01050"></a>01050 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l01051"></a>01051 <span class="comment">/** \brief  This function will read the I_AM_COORD sub register.</span>
<a name="l01052"></a>01052 <span class="comment"> *</span>
<a name="l01053"></a>01053 <span class="comment"> *  \retval 0 Not coordinator.</span>
<a name="l01054"></a>01054 <span class="comment"> *  \retval 1 Coordinator role enabled.</span>
<a name="l01055"></a>01055 <span class="comment"> */</span>
<a name="l01056"></a>01056 uint8_t
<a name="l01057"></a><a class="code" href="a01710.html#gae3be9b1c85688303eb401f88c407ecd5">01057</a> <a class="code" href="a01710.html#gae3be9b1c85688303eb401f88c407ecd5" title="This function will read the I_AM_COORD sub register.">radio_get_device_role</a>(<span class="keywordtype">void</span>)
<a name="l01058"></a>01058 {
<a name="l01059"></a>01059     <span class="keywordflow">return</span> <a class="code" href="a01709.html#ga3af07027e6111b4d8798bf3b33dce065" title="This function reads the value of a specific subregister.">hal_subregister_read</a>(<a class="code" href="a00763.html#a0111e087406382c6197244d030b39dac" title="Access parameters for sub-register I_AM_COORD in register RG_CSMA_SEED_1.">SR_I_AM_COORD</a>);
<a name="l01060"></a>01060 }
<a name="l01061"></a>01061 
<a name="l01062"></a>01062 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l01063"></a>01063 <span class="comment">/** \brief  This function will set the I_AM_COORD sub register.</span>
<a name="l01064"></a>01064 <span class="comment"> *</span>
<a name="l01065"></a>01065 <span class="comment"> *  \param[in] i_am_coordinator If this parameter is true, the associated</span>
<a name="l01066"></a>01066 <span class="comment"> *                              coordinator role will be enabled in the radio</span>
<a name="l01067"></a>01067 <span class="comment"> *                              transceiver&#39;s address filter.</span>
<a name="l01068"></a>01068 <span class="comment"> *                              False disables the same feature.</span>
<a name="l01069"></a>01069 <span class="comment"> */</span>
<a name="l01070"></a>01070 <span class="keywordtype">void</span>
<a name="l01071"></a><a class="code" href="a01710.html#ga341915908f7757056728a35e23431a24">01071</a> <a class="code" href="a01710.html#ga341915908f7757056728a35e23431a24" title="This function will set the I_AM_COORD sub register.">radio_set_device_role</a>(<span class="keywordtype">bool</span> i_am_coordinator)
<a name="l01072"></a>01072 {
<a name="l01073"></a>01073     <a class="code" href="a01709.html#ga3577f9187e7d5af04be3fd1377307ffa" title="This function writes a new value to one of the radio transceiver&#39;s subregisters.">hal_subregister_write</a>(<a class="code" href="a00763.html#a0111e087406382c6197244d030b39dac" title="Access parameters for sub-register I_AM_COORD in register RG_CSMA_SEED_1.">SR_I_AM_COORD</a>, i_am_coordinator);
<a name="l01074"></a>01074 }
<a name="l01075"></a>01075 
<a name="l01076"></a>01076 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l01077"></a>01077 <span class="comment">/** \brief  This function will return the PANID used by the address filter.</span>
<a name="l01078"></a>01078 <span class="comment"> *</span>
<a name="l01079"></a>01079 <span class="comment"> *  \retval Any value from 0 to 0xFFFF.</span>
<a name="l01080"></a>01080 <span class="comment"> */</span>
<a name="l01081"></a>01081 uint16_t
<a name="l01082"></a><a class="code" href="a01710.html#ga03f8d1a25d36623015a9bb875b38bae6">01082</a> <a class="code" href="a01710.html#ga03f8d1a25d36623015a9bb875b38bae6" title="This function will return the PANID used by the address filter.">radio_get_pan_id</a>(<span class="keywordtype">void</span>)
<a name="l01083"></a>01083 {
<a name="l01084"></a>01084 
<a name="l01085"></a>01085     uint8_t pan_id_15_8 = <a class="code" href="a01709.html#gaf3c702dd022b52907dc882a346a16819" title="This function reads data from one of the radio transceiver&#39;s registers.">hal_register_read</a>(<a class="code" href="a00763.html#a30cf03f218f9c36554315f737abbedd5" title="Offset for register PAN_ID_1.">RG_PAN_ID_1</a>); <span class="comment">/*  Read pan_id_15_8. */</span>
<a name="l01086"></a>01086     uint8_t pan_id_7_0 = <a class="code" href="a01709.html#gaf3c702dd022b52907dc882a346a16819" title="This function reads data from one of the radio transceiver&#39;s registers.">hal_register_read</a>(<a class="code" href="a00763.html#a7e9a100296620bd87365a5355e3ff28d" title="Offset for register PAN_ID_0.">RG_PAN_ID_0</a>); <span class="comment">/*  Read pan_id_7_0. */</span>
<a name="l01087"></a>01087 
<a name="l01088"></a>01088     uint16_t pan_id = ((uint16_t)(pan_id_15_8 &lt;&lt; 8)) | pan_id_7_0;
<a name="l01089"></a>01089 
<a name="l01090"></a>01090     <span class="keywordflow">return</span> pan_id;
<a name="l01091"></a>01091 }
<a name="l01092"></a>01092 
<a name="l01093"></a>01093 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l01094"></a>01094 <span class="comment">/** \brief  This function will set the PANID used by the address filter.</span>
<a name="l01095"></a>01095 <span class="comment"> *</span>
<a name="l01096"></a>01096 <span class="comment"> *  \param  new_pan_id Desired PANID. Can be any value from 0x0000 to 0xFFFF</span>
<a name="l01097"></a>01097 <span class="comment"> */</span>
<a name="l01098"></a>01098 <span class="keywordtype">void</span>
<a name="l01099"></a><a class="code" href="a01710.html#gaa83b626a6ad6b73889df5748f263fa06">01099</a> <a class="code" href="a01710.html#gaa83b626a6ad6b73889df5748f263fa06" title="This function will set the PANID used by the address filter.">radio_set_pan_id</a>(uint16_t new_pan_id)
<a name="l01100"></a>01100 {
<a name="l01101"></a>01101 
<a name="l01102"></a>01102     uint8_t pan_byte = new_pan_id &amp; 0xFF; <span class="comment">/*  Extract new_pan_id_7_0. */</span>
<a name="l01103"></a>01103     <a class="code" href="a01709.html#ga733238be74ad06adfc1720e56427a447" title="This function writes a new value to one of the radio transceiver&#39;s registers.">hal_register_write</a>(<a class="code" href="a00763.html#a7e9a100296620bd87365a5355e3ff28d" title="Offset for register PAN_ID_0.">RG_PAN_ID_0</a>, pan_byte);
<a name="l01104"></a>01104 
<a name="l01105"></a>01105     pan_byte = (new_pan_id &gt;&gt; 8*1) &amp; 0xFF;  <span class="comment">/*  Extract new_pan_id_15_8. */</span>
<a name="l01106"></a>01106     <a class="code" href="a01709.html#ga733238be74ad06adfc1720e56427a447" title="This function writes a new value to one of the radio transceiver&#39;s registers.">hal_register_write</a>(<a class="code" href="a00763.html#a30cf03f218f9c36554315f737abbedd5" title="Offset for register PAN_ID_1.">RG_PAN_ID_1</a>, pan_byte);
<a name="l01107"></a>01107 }
<a name="l01108"></a>01108 
<a name="l01109"></a>01109 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l01110"></a>01110 <span class="comment">/** \brief  This function will return the current short address used by the</span>
<a name="l01111"></a>01111 <span class="comment"> *          address filter.</span>
<a name="l01112"></a>01112 <span class="comment"> *</span>
<a name="l01113"></a>01113 <span class="comment"> *  \retval Any value from 0x0000 to 0xFFFF</span>
<a name="l01114"></a>01114 <span class="comment"> */</span>
<a name="l01115"></a>01115 uint16_t
<a name="l01116"></a><a class="code" href="a01710.html#gad8bc0ed106db566a0cdfc3d487ef86a8">01116</a> <a class="code" href="a01710.html#gad8bc0ed106db566a0cdfc3d487ef86a8" title="This function will return the current short address used by the address filter.">radio_get_short_address</a>(<span class="keywordtype">void</span>)
<a name="l01117"></a>01117 {
<a name="l01118"></a>01118 
<a name="l01119"></a>01119     uint8_t short_address_15_8 = <a class="code" href="a01709.html#gaf3c702dd022b52907dc882a346a16819" title="This function reads data from one of the radio transceiver&#39;s registers.">hal_register_read</a>(<a class="code" href="a00763.html#aa60598fa1041cdf9caa245cc9fbd52cd" title="Offset for register SHORT_ADDR_1.">RG_SHORT_ADDR_1</a>); <span class="comment">/*  Read short_address_15_8. */</span>
<a name="l01120"></a>01120     uint8_t short_address_7_0  = <a class="code" href="a01709.html#gaf3c702dd022b52907dc882a346a16819" title="This function reads data from one of the radio transceiver&#39;s registers.">hal_register_read</a>(<a class="code" href="a00763.html#aa60598fa1041cdf9caa245cc9fbd52cd" title="Offset for register SHORT_ADDR_1.">RG_SHORT_ADDR_1</a>); <span class="comment">/*  Read short_address_7_0. */</span>
<a name="l01121"></a>01121 
<a name="l01122"></a>01122     uint16_t short_address = ((uint16_t)(short_address_15_8 &lt;&lt; 8)) | short_address_7_0;
<a name="l01123"></a>01123 
<a name="l01124"></a>01124     <span class="keywordflow">return</span> short_address;
<a name="l01125"></a>01125 }
<a name="l01126"></a>01126 
<a name="l01127"></a>01127 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l01128"></a>01128 <span class="comment">/** \brief  This function will set the short address used by the address filter.</span>
<a name="l01129"></a>01129 <span class="comment"> *</span>
<a name="l01130"></a>01130 <span class="comment"> *  \param  new_short_address Short address to be used by the address filter.</span>
<a name="l01131"></a>01131 <span class="comment"> */</span>
<a name="l01132"></a>01132 <span class="keywordtype">void</span>
<a name="l01133"></a><a class="code" href="a01710.html#ga3e03858ffe27d2da715ba98f466c4c8d">01133</a> <a class="code" href="a01710.html#ga3e03858ffe27d2da715ba98f466c4c8d" title="This function will set the short address used by the address filter.">radio_set_short_address</a>(uint16_t new_short_address)
<a name="l01134"></a>01134 {
<a name="l01135"></a>01135 
<a name="l01136"></a>01136     uint8_t short_address_byte = new_short_address &amp; 0xFF; <span class="comment">/*  Extract short_address_7_0. */</span>
<a name="l01137"></a>01137     <a class="code" href="a01709.html#ga733238be74ad06adfc1720e56427a447" title="This function writes a new value to one of the radio transceiver&#39;s registers.">hal_register_write</a>(<a class="code" href="a00763.html#a7eb78713946ea45d4b96dea4fdfd635b" title="Offset for register SHORT_ADDR_0.">RG_SHORT_ADDR_0</a>, short_address_byte);
<a name="l01138"></a>01138 
<a name="l01139"></a>01139     short_address_byte = (new_short_address &gt;&gt; 8*1) &amp; 0xFF; <span class="comment">/*  Extract short_address_15_8. */</span>
<a name="l01140"></a>01140     <a class="code" href="a01709.html#ga733238be74ad06adfc1720e56427a447" title="This function writes a new value to one of the radio transceiver&#39;s registers.">hal_register_write</a>(<a class="code" href="a00763.html#aa60598fa1041cdf9caa245cc9fbd52cd" title="Offset for register SHORT_ADDR_1.">RG_SHORT_ADDR_1</a>, short_address_byte);
<a name="l01141"></a>01141 }
<a name="l01142"></a>01142 
<a name="l01143"></a>01143 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l01144"></a>01144 <span class="comment">/** \brief  This function will read the extended address used by the address</span>
<a name="l01145"></a>01145 <span class="comment"> *          filter.</span>
<a name="l01146"></a>01146 <span class="comment"> *</span>
<a name="l01147"></a>01147 <span class="comment"> *  \note In this function a pointer is used to convey the 64-bit result, since</span>
<a name="l01148"></a>01148 <span class="comment"> *        it is very inefficient to use the stack for this.</span>
<a name="l01149"></a>01149 <span class="comment"> *</span>
<a name="l01150"></a>01150 <span class="comment"> *  \return Extended Address, any 64-bit value.</span>
<a name="l01151"></a>01151 <span class="comment"> */</span>
<a name="l01152"></a>01152 <span class="keywordtype">void</span>
<a name="l01153"></a><a class="code" href="a01710.html#ga18683051789bac42b4f06db7fe5742b0">01153</a> <a class="code" href="a01710.html#ga18683051789bac42b4f06db7fe5742b0" title="This function will read the extended address used by the address filter.">radio_get_extended_address</a>(uint8_t *extended_address)
<a name="l01154"></a>01154 {
<a name="l01155"></a>01155     *extended_address++ = <a class="code" href="a01709.html#gaf3c702dd022b52907dc882a346a16819" title="This function reads data from one of the radio transceiver&#39;s registers.">hal_register_read</a>(<a class="code" href="a00763.html#a15e749d4ff747c1066a644142088c354" title="Offset for register IEEE_ADDR_0.">RG_IEEE_ADDR_0</a>);
<a name="l01156"></a>01156     *extended_address++ = <a class="code" href="a01709.html#gaf3c702dd022b52907dc882a346a16819" title="This function reads data from one of the radio transceiver&#39;s registers.">hal_register_read</a>(<a class="code" href="a00763.html#a1446d842abbb6236c0cc6e81aa55afd5" title="Offset for register IEEE_ADDR_1.">RG_IEEE_ADDR_1</a>);
<a name="l01157"></a>01157     *extended_address++ = <a class="code" href="a01709.html#gaf3c702dd022b52907dc882a346a16819" title="This function reads data from one of the radio transceiver&#39;s registers.">hal_register_read</a>(<a class="code" href="a00763.html#addc18e32ea6a4e7090d003a065325a07" title="Offset for register IEEE_ADDR_2.">RG_IEEE_ADDR_2</a>);
<a name="l01158"></a>01158     *extended_address++ = <a class="code" href="a01709.html#gaf3c702dd022b52907dc882a346a16819" title="This function reads data from one of the radio transceiver&#39;s registers.">hal_register_read</a>(<a class="code" href="a00763.html#a4363d1043e3ca7fd103c8671a7bb816c" title="Offset for register IEEE_ADDR_3.">RG_IEEE_ADDR_3</a>);
<a name="l01159"></a>01159     *extended_address++ = <a class="code" href="a01709.html#gaf3c702dd022b52907dc882a346a16819" title="This function reads data from one of the radio transceiver&#39;s registers.">hal_register_read</a>(<a class="code" href="a00763.html#a0af60fe759f1fb20a5fd1f1a6485ef55" title="Offset for register IEEE_ADDR_4.">RG_IEEE_ADDR_4</a>);
<a name="l01160"></a>01160     *extended_address++ = <a class="code" href="a01709.html#gaf3c702dd022b52907dc882a346a16819" title="This function reads data from one of the radio transceiver&#39;s registers.">hal_register_read</a>(<a class="code" href="a00763.html#a51e16dcb63978ac7f2da04f1d22f64d5" title="Offset for register IEEE_ADDR_5.">RG_IEEE_ADDR_5</a>);
<a name="l01161"></a>01161     *extended_address++ = <a class="code" href="a01709.html#gaf3c702dd022b52907dc882a346a16819" title="This function reads data from one of the radio transceiver&#39;s registers.">hal_register_read</a>(<a class="code" href="a00763.html#a7a08fe5c18ce6b6aab8258e60437dbbd" title="Offset for register IEEE_ADDR_6.">RG_IEEE_ADDR_6</a>);
<a name="l01162"></a>01162     *extended_address   = <a class="code" href="a01709.html#gaf3c702dd022b52907dc882a346a16819" title="This function reads data from one of the radio transceiver&#39;s registers.">hal_register_read</a>(<a class="code" href="a00763.html#afc4833334492f3f1ca57d51f96a4a925" title="Offset for register IEEE_ADDR_7.">RG_IEEE_ADDR_7</a>);
<a name="l01163"></a>01163 }
<a name="l01164"></a>01164 
<a name="l01165"></a>01165 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l01166"></a>01166 <span class="comment">/** \brief  This function will set a new extended address to be used by the</span>
<a name="l01167"></a>01167 <span class="comment"> *          address filter.</span>
<a name="l01168"></a>01168 <span class="comment"> *</span>
<a name="l01169"></a>01169 <span class="comment"> *  \param  extended_address Extended address to be used by the address filter.</span>
<a name="l01170"></a>01170 <span class="comment"> */</span>
<a name="l01171"></a>01171 <span class="keywordtype">void</span>
<a name="l01172"></a><a class="code" href="a01710.html#gabd8ff7b98defda140e74183f8b1092f2">01172</a> <a class="code" href="a01710.html#gabd8ff7b98defda140e74183f8b1092f2" title="This function will set a new extended address to be used by the address filter.">radio_set_extended_address</a>(uint8_t *extended_address)
<a name="l01173"></a>01173 {
<a name="l01174"></a>01174     <a class="code" href="a01709.html#ga733238be74ad06adfc1720e56427a447" title="This function writes a new value to one of the radio transceiver&#39;s registers.">hal_register_write</a>(<a class="code" href="a00763.html#a15e749d4ff747c1066a644142088c354" title="Offset for register IEEE_ADDR_0.">RG_IEEE_ADDR_0</a>, *extended_address++);
<a name="l01175"></a>01175     <a class="code" href="a01709.html#ga733238be74ad06adfc1720e56427a447" title="This function writes a new value to one of the radio transceiver&#39;s registers.">hal_register_write</a>(<a class="code" href="a00763.html#a1446d842abbb6236c0cc6e81aa55afd5" title="Offset for register IEEE_ADDR_1.">RG_IEEE_ADDR_1</a>, *extended_address++);
<a name="l01176"></a>01176     <a class="code" href="a01709.html#ga733238be74ad06adfc1720e56427a447" title="This function writes a new value to one of the radio transceiver&#39;s registers.">hal_register_write</a>(<a class="code" href="a00763.html#addc18e32ea6a4e7090d003a065325a07" title="Offset for register IEEE_ADDR_2.">RG_IEEE_ADDR_2</a>, *extended_address++);
<a name="l01177"></a>01177     <a class="code" href="a01709.html#ga733238be74ad06adfc1720e56427a447" title="This function writes a new value to one of the radio transceiver&#39;s registers.">hal_register_write</a>(<a class="code" href="a00763.html#a4363d1043e3ca7fd103c8671a7bb816c" title="Offset for register IEEE_ADDR_3.">RG_IEEE_ADDR_3</a>, *extended_address++);
<a name="l01178"></a>01178     <a class="code" href="a01709.html#ga733238be74ad06adfc1720e56427a447" title="This function writes a new value to one of the radio transceiver&#39;s registers.">hal_register_write</a>(<a class="code" href="a00763.html#a0af60fe759f1fb20a5fd1f1a6485ef55" title="Offset for register IEEE_ADDR_4.">RG_IEEE_ADDR_4</a>, *extended_address++);
<a name="l01179"></a>01179     <a class="code" href="a01709.html#ga733238be74ad06adfc1720e56427a447" title="This function writes a new value to one of the radio transceiver&#39;s registers.">hal_register_write</a>(<a class="code" href="a00763.html#a51e16dcb63978ac7f2da04f1d22f64d5" title="Offset for register IEEE_ADDR_5.">RG_IEEE_ADDR_5</a>, *extended_address++);
<a name="l01180"></a>01180     <a class="code" href="a01709.html#ga733238be74ad06adfc1720e56427a447" title="This function writes a new value to one of the radio transceiver&#39;s registers.">hal_register_write</a>(<a class="code" href="a00763.html#a7a08fe5c18ce6b6aab8258e60437dbbd" title="Offset for register IEEE_ADDR_6.">RG_IEEE_ADDR_6</a>, *extended_address++);
<a name="l01181"></a>01181     <a class="code" href="a01709.html#ga733238be74ad06adfc1720e56427a447" title="This function writes a new value to one of the radio transceiver&#39;s registers.">hal_register_write</a>(<a class="code" href="a00763.html#afc4833334492f3f1ca57d51f96a4a925" title="Offset for register IEEE_ADDR_7.">RG_IEEE_ADDR_7</a>, *extended_address++);
<a name="l01182"></a>01182 }
<a name="l01183"></a>01183 
<a name="l01184"></a>01184 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l01185"></a>01185 <span class="comment">/** \brief  This function will configure the CSMA algorithm used by the radio</span>
<a name="l01186"></a>01186 <span class="comment"> *          transceiver when transmitting data from TX_ARET_ON state.</span>
<a name="l01187"></a>01187 <span class="comment"> *</span>
<a name="l01188"></a>01188 <span class="comment"> *  \param  seed0 Lower 8 bits of the seed used for the random number generator</span>
<a name="l01189"></a>01189 <span class="comment"> *                in the CSMA algorithm. Value range: 0 to 255.</span>
<a name="l01190"></a>01190 <span class="comment"> *  \param  be_csma_seed1 Is a combined argument of the MIN_BE, MAX_CSMA_RETRIES</span>
<a name="l01191"></a>01191 <span class="comment"> *                        and SEED1 variables:</span>
<a name="l01192"></a>01192 <span class="comment"> *                        -# MIN_BE: Bit[7:6] Minimum back-off exponent in the</span>
<a name="l01193"></a>01193 <span class="comment"> *                           CSMA/CA algorithm.</span>
<a name="l01194"></a>01194 <span class="comment"> *                        -# MAX_CSMA_RETRIES: Bit[5:3] Number of retries in</span>
<a name="l01195"></a>01195 <span class="comment"> *                          TX_ARET_ON mode to repeat the CSMA/CA procedures</span>
<a name="l01196"></a>01196 <span class="comment"> *                          before the ARET procedure gives up.</span>
<a name="l01197"></a>01197 <span class="comment"> *                        -# SEED1: Bits[2:0] Higher 3 bits of CSMA_SEED, bits[10:8]</span>
<a name="l01198"></a>01198 <span class="comment"> *                           Seed for the random number generator in the</span>
<a name="l01199"></a>01199 <span class="comment"> *                           CSMA/CA algorithm.</span>
<a name="l01200"></a>01200 <span class="comment"> *  \retval RADIO_SUCCESS The CSMA algorithm was configured successfully.</span>
<a name="l01201"></a>01201 <span class="comment"> *  \retval RADIO_WRONG_STATE This function should not be called in the</span>
<a name="l01202"></a>01202 <span class="comment"> *                          SLEEP state.</span>
<a name="l01203"></a>01203 <span class="comment"> */</span>
<a name="l01204"></a>01204 <a class="code" href="a01710.html#gab6afacea6a7310707d47839506c30a73" title="This enumeration defines the possible return values for the TAT API functions.">radio_status_t</a>
<a name="l01205"></a><a class="code" href="a01710.html#ga6fc45c43ddf10d2e44da12ed07bd4ba0">01205</a> <a class="code" href="a01710.html#ga6fc45c43ddf10d2e44da12ed07bd4ba0" title="This function will configure the CSMA algorithm used by the radio transceiver when transmitting data ...">radio_configure_csma</a>(uint8_t seed0, uint8_t be_csma_seed1)
<a name="l01206"></a>01206 {
<a name="l01207"></a>01207 
<a name="l01208"></a>01208     <span class="comment">/*Check state.*/</span>
<a name="l01209"></a>01209     <span class="keywordflow">if</span> (<a class="code" href="a01710.html#ga7c4b1fbd30174589d1a0660f30a543e3" title="This function checks if the radio transceiver is sleeping.">radio_is_sleeping</a>() == <span class="keyword">true</span>){
<a name="l01210"></a>01210         <span class="keywordflow">return</span> <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ae2cba4f4b63e5ff3c6e3a4bbbb1358e5" title="The end-user tried to do an invalid state transition.">RADIO_WRONG_STATE</a>;
<a name="l01211"></a>01211     }
<a name="l01212"></a>01212 
<a name="l01213"></a>01213     <span class="comment">/*Extract parameters, and configure the CSMA-CA algorithm.*/</span>
<a name="l01214"></a>01214     uint8_t back_off_exponent = (be_csma_seed1 &amp; 0xC0) &gt;&gt; 6;
<a name="l01215"></a>01215     uint8_t csma_retries      = (be_csma_seed1 &amp; 0x38) &gt;&gt; 3;
<a name="l01216"></a>01216     uint8_t seed1             = (be_csma_seed1 &amp; 0x07);
<a name="l01217"></a>01217 
<a name="l01218"></a>01218     <a class="code" href="a01709.html#ga3577f9187e7d5af04be3fd1377307ffa" title="This function writes a new value to one of the radio transceiver&#39;s subregisters.">hal_subregister_write</a>(<a class="code" href="a00763.html#a1c29b8561f46d5949033e45c4a0ddcd1" title="Access parameters for sub-register MAX_FRAME_RETRIES in register RG_XAH_CTRL_0.">SR_MAX_FRAME_RETRIES</a>, 0); <span class="comment">/* AT86RF230 rev A errata. */</span>
<a name="l01219"></a>01219     <a class="code" href="a01709.html#ga3577f9187e7d5af04be3fd1377307ffa" title="This function writes a new value to one of the radio transceiver&#39;s subregisters.">hal_subregister_write</a>(<a class="code" href="a00763.html#a90d23d615a36396e2d4ce50fc1126a60" title="Access parameters for sub-register MAX_CSMA_RETRIES in register RG_XAH_CTRL_0.">SR_MAX_CSMA_RETRIES</a>, csma_retries);
<a name="l01220"></a>01220     <a class="code" href="a01709.html#ga3577f9187e7d5af04be3fd1377307ffa" title="This function writes a new value to one of the radio transceiver&#39;s subregisters.">hal_subregister_write</a>(<a class="code" href="a00763.html#a5c34ba9a75fedbe5c8366f6631f183ae" title="Access parameters for sub-register MIN_BE in register RG_CSMA_SEED_1.">SR_MIN_BE</a>, back_off_exponent);
<a name="l01221"></a>01221     <a class="code" href="a01709.html#ga733238be74ad06adfc1720e56427a447" title="This function writes a new value to one of the radio transceiver&#39;s registers.">hal_register_write</a>(<a class="code" href="a00763.html#a0be03a19a6b1cf46a550cd0a5dc1b55b" title="Offset for register CSMA_SEED_0.">RG_CSMA_SEED_0</a>, seed0);
<a name="l01222"></a>01222     <a class="code" href="a01709.html#ga3577f9187e7d5af04be3fd1377307ffa" title="This function writes a new value to one of the radio transceiver&#39;s subregisters.">hal_subregister_write</a>(<a class="code" href="a00763.html#a241aa49cdb91c3abad40cc050e10b144" title="Access parameters for sub-register CSMA_SEED_1 in register RG_CSMA_SEED_1.">SR_CSMA_SEED_1</a>, seed1);
<a name="l01223"></a>01223 
<a name="l01224"></a>01224     <span class="keywordflow">return</span> <a class="code" href="a01710.html#ggab6afacea6a7310707d47839506c30a73ae0cc54bacebeb0eccbddcca9ba2315fc" title="The requested service was performed successfully.">RADIO_SUCCESS</a>;
<a name="l01225"></a>01225 }
<a name="l01226"></a>01226 
<a name="l01227"></a>01227 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l01228"></a>01228 <span class="comment">/**</span>
<a name="l01229"></a>01229 <span class="comment">    \brief Calibrate the internal RC oscillator</span>
<a name="l01230"></a>01230 <span class="comment"></span>
<a name="l01231"></a>01231 <span class="comment">    This function calibrates the internal RC oscillator, based</span>
<a name="l01232"></a>01232 <span class="comment">    on the 1 MHz clock supplied by the AT86RF2xx. In order to</span>
<a name="l01233"></a>01233 <span class="comment">    verify the calibration result you can program the CKOUT fuse</span>
<a name="l01234"></a>01234 <span class="comment">    and monitor the CPU clock on an I/O pin.</span>
<a name="l01235"></a>01235 <span class="comment"></span>
<a name="l01236"></a>01236 <span class="comment">    \return TRUE if calibrate passed; FALSE if calibrate failed.</span>
<a name="l01237"></a>01237 <span class="comment">*/</span>
<a name="l01238"></a>01238 <span class="keywordtype">bool</span>
<a name="l01239"></a><a class="code" href="a01710.html#gae5a7da999baa03269a350ae58c55e2ec">01239</a> <a class="code" href="a01710.html#gae5a7da999baa03269a350ae58c55e2ec" title="Calibrate the internal RC oscillator.">calibrate_rc_osc_clkm</a>(<span class="keywordtype">void</span>)
<a name="l01240"></a>01240 {
<a name="l01241"></a>01241         <span class="keywordtype">bool</span> success = <span class="keyword">false</span>;
<a name="l01242"></a>01242 
<a name="l01243"></a>01243     <span class="comment">/*  Use the 1 MHz CLK_M from the AT86RF230. */</span>
<a name="l01244"></a>01244     uint16_t temp, counter;
<a name="l01245"></a>01245     uint8_t osccal_saved;
<a name="l01246"></a>01246     uint8_t tccr2b, tccr1b, tccr1a;
<a name="l01247"></a>01247 
<a name="l01248"></a>01248     <span class="comment">/*  in the following line, 1000000ULL represents the 1MHz input signal */</span>
<a name="l01249"></a>01249     <span class="comment">/*  from the radio.  265 is the number of counts to overflow 8-bit */</span>
<a name="l01250"></a>01250     <span class="comment">/*  timer 2.  32 is the divide by 32 prescaler for timer 1.  F_CPU is */</span>
<a name="l01251"></a>01251     <span class="comment">/*  the main clock frequency. */</span>
<a name="l01252"></a>01252 <span class="preprocessor">#define TARGETVAL ((1000000ULL * 256 * 32) / F_CPU)</span>
<a name="l01253"></a>01253 <span class="preprocessor"></span>
<a name="l01254"></a>01254 
<a name="l01255"></a>01255         osccal_saved = OSCCAL;
<a name="l01256"></a>01256         cli();
<a name="l01257"></a>01257 
<a name="l01258"></a>01258         <a class="code" href="a01710.html#gaed81adcaca247848a64a7b612b1df5d5" title="This function changes the prescaler on the CLKM pin.">radio_set_clock_speed</a>(<span class="keyword">true</span>, <a class="code" href="a00763.html#a156a5c1dbce856cd6be41ff6f75fd716" title="Constant CLKM_1MHz for sub-register SR_CLKM_CTRL.">CLKM_1MHz</a>);
<a name="l01259"></a>01259 
<a name="l01260"></a>01260     <span class="comment">/*  Save current values of timer status. */</span>
<a name="l01261"></a>01261         tccr2b = TCCR2B;
<a name="l01262"></a>01262         tccr1b = TCCR1B;
<a name="l01263"></a>01263         tccr1a = TCCR1A;
<a name="l01264"></a>01264 
<a name="l01265"></a>01265     <span class="comment">/*  Stop timers 1 and 2. */</span>
<a name="l01266"></a>01266     <span class="comment">/*  Set timer 1 to normal mode (no CTC, no PWM, just count). */</span>
<a name="l01267"></a>01267         TCCR2B = 0;
<a name="l01268"></a>01268         TCCR1B = 0;
<a name="l01269"></a>01269         TCCR1A = 0;
<a name="l01270"></a>01270 
<a name="l01271"></a>01271     <span class="keywordflow">for</span> (counter = 0; counter &lt; 1000;  counter++){
<a name="l01272"></a>01272         <span class="comment">/*  Delete pending timer 1 and 2 interrupts, and clear the */</span>
<a name="l01273"></a>01273         <span class="comment">/*  counters. */</span>
<a name="l01274"></a>01274             TIFR1 = 0xFF;
<a name="l01275"></a>01275             TIFR2 = 0xFF;
<a name="l01276"></a>01276             TCNT2 = 0;
<a name="l01277"></a>01277             TCNT1 = 0;
<a name="l01278"></a>01278         <span class="comment">/*  Timer 2 driven from clock divided by 32 */</span>
<a name="l01279"></a>01279             TCCR2B = (1 &lt;&lt; CS21) | (1 &lt;&lt; CS20);
<a name="l01280"></a>01280         <span class="comment">/*  Timer 1 driven with external clock */</span>
<a name="l01281"></a>01281             TCCR1B = (1 &lt;&lt; CS12) | (1 &lt;&lt; CS11);
<a name="l01282"></a>01282 
<a name="l01283"></a>01283         <span class="comment">/*  Wait for timer 2 to overflow. */</span>
<a name="l01284"></a>01284         <span class="keywordflow">while</span> (!(TIFR2 &amp; (1 &lt;&lt; TOV2))){
<a name="l01285"></a>01285                 ;
<a name="l01286"></a>01286         }
<a name="l01287"></a>01287 
<a name="l01288"></a>01288         <span class="comment">/*  Stop timer 1.  Now, TCNT1 contains the number of CPU cycles */</span>
<a name="l01289"></a>01289         <span class="comment">/*  counted while timer 2 was counting */</span>
<a name="l01290"></a>01290             TCCR1B = 0;
<a name="l01291"></a>01291             TCCR2B = 0;
<a name="l01292"></a>01292 
<a name="l01293"></a>01293             temp = TCNT1;
<a name="l01294"></a>01294 
<a name="l01295"></a>01295         <span class="keywordflow">if</span> (temp &lt; (uint16_t)(0.995 * TARGETVAL)){
<a name="l01296"></a>01296             <span class="comment">/*  Too fast, slow down */</span>
<a name="l01297"></a>01297                 OSCCAL--;
<a name="l01298"></a>01298         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (temp &gt; (uint16_t)(1.005 * TARGETVAL)){
<a name="l01299"></a>01299             <span class="comment">/*  Too slow, speed up */</span>
<a name="l01300"></a>01300                 OSCCAL++;
<a name="l01301"></a>01301         } <span class="keywordflow">else</span> {
<a name="l01302"></a>01302             <span class="comment">/*  We are within +/- 0.5 % of our target frequency, so we&#39;re */</span>
<a name="l01303"></a>01303             <span class="comment">/*  done. */</span>
<a name="l01304"></a>01304                 success = <span class="keyword">true</span>;
<a name="l01305"></a>01305                 <span class="keywordflow">break</span>;
<a name="l01306"></a>01306             }
<a name="l01307"></a>01307         }
<a name="l01308"></a>01308 
<a name="l01309"></a>01309         <a class="code" href="a01710.html#gaed81adcaca247848a64a7b612b1df5d5" title="This function changes the prescaler on the CLKM pin.">radio_set_clock_speed</a>(<span class="keyword">true</span>, CLKM_DISABLED);
<a name="l01310"></a>01310 
<a name="l01311"></a>01311     <span class="comment">/*  restore timer status regs */</span>
<a name="l01312"></a>01312         TCCR2B = tccr2b;
<a name="l01313"></a>01313         TCCR1B = tccr1b;
<a name="l01314"></a>01314         TCCR1A = tccr1a;
<a name="l01315"></a>01315     <span class="keywordflow">if</span> (!success){
<a name="l01316"></a>01316         <span class="comment">/*  We failed, therefore restore previous OSCCAL value. */</span>
<a name="l01317"></a>01317             OSCCAL = osccal_saved;
<a name="l01318"></a>01318         }
<a name="l01319"></a>01319 
<a name="l01320"></a>01320         <span class="keywordflow">return</span> success;
<a name="l01321"></a>01321 }
<a name="l01322"></a>01322 
<a name="l01323"></a>01323 <span class="comment">/*----------------------------------------------------------------------------*/</span><span class="comment"></span>
<a name="l01324"></a>01324 <span class="comment">/**</span>
<a name="l01325"></a>01325 <span class="comment">    \brief Calibrate the internal RC oscillator</span>
<a name="l01326"></a>01326 <span class="comment"></span>
<a name="l01327"></a>01327 <span class="comment">    This function calibrates the internal RC oscillator, based</span>
<a name="l01328"></a>01328 <span class="comment">    on an external 32KHz crystal connected to TIMER2. In order to</span>
<a name="l01329"></a>01329 <span class="comment">    verify the calibration result you can program the CKOUT fuse</span>
<a name="l01330"></a>01330 <span class="comment">    and monitor the CPU clock on an I/O pin.</span>
<a name="l01331"></a>01331 <span class="comment">*/</span>
<a name="l01332"></a>01332 <span class="keywordtype">void</span>
<a name="l01333"></a><a class="code" href="a01710.html#gaaa84b1c0e7ec53220e17cabca6832b52">01333</a> <a class="code" href="a01710.html#gaaa84b1c0e7ec53220e17cabca6832b52" title="Calibrate the internal RC oscillator.">calibrate_rc_osc_32k</a>(<span class="keywordtype">void</span>)
<a name="l01334"></a>01334 {
<a name="l01335"></a>01335     <span class="comment">/* Calibrate RC Oscillator: The calibration routine is done by clocking TIMER2</span>
<a name="l01336"></a>01336 <span class="comment">     * from the external 32kHz crystal while running an internal timer simultaneously.</span>
<a name="l01337"></a>01337 <span class="comment">     * The internal timer will be clocked at the same speed as the internal RC</span>
<a name="l01338"></a>01338 <span class="comment">     * oscillator, while TIMER2 is running at 32768 Hz. This way it is not necessary</span>
<a name="l01339"></a>01339 <span class="comment">     * to use a timed loop, and keep track cycles in timed loop vs. optimization</span>
<a name="l01340"></a>01340 <span class="comment">     * and compiler.</span>
<a name="l01341"></a>01341 <span class="comment">     */</span>
<a name="l01342"></a>01342     uint8_t osccal_original = OSCCAL;
<a name="l01343"></a>01343     <span class="keyword">volatile</span> uint16_t temp;
<a name="l01344"></a>01344         
<a name="l01345"></a>01345     <span class="comment">/* This is bad practice, but seems to work. */</span>
<a name="l01346"></a>01346     OSCCAL = 0x80;
<a name="l01347"></a>01347 
<a name="l01348"></a>01348 
<a name="l01349"></a>01349   <span class="comment">//    PRR0 &amp;= ~((1 &lt;&lt; PRTIM2)|(1 &lt;&lt; PRTIM1)); /*  Enable Timer 1 and 2 */</span>
<a name="l01350"></a>01350 
<a name="l01351"></a>01351     TIMSK2 = 0x00; <span class="comment">/*  Disable Timer/Counter 2 interrupts. */</span>
<a name="l01352"></a>01352     TIMSK1 = 0x00; <span class="comment">/*  Disable Timer/Counter 1 interrupts. */</span>
<a name="l01353"></a>01353 
<a name="l01354"></a>01354     <span class="comment">/* Enable TIMER/COUNTER 2 to be clocked from the external 32kHz clock crystal.</span>
<a name="l01355"></a>01355 <span class="comment">     * Then wait for the timer to become stable before doing any calibration.</span>
<a name="l01356"></a>01356 <span class="comment">     */</span>
<a name="l01357"></a>01357     ASSR |= (1 &lt;&lt; AS2);
<a name="l01358"></a>01358     <span class="keywordflow">while</span> (ASSR &amp; ((1 &lt;&lt; TCN2UB)|(1 &lt;&lt; OCR2AUB)|(1 &lt;&lt; TCR2AUB)|(1 &lt;&lt; TCR2BUB))) { ; }
<a name="l01359"></a>01359     TCCR2B = 1 &lt;&lt; CS20;   <span class="comment">/* run timer 2 at divide by 1 (32KHz) */</span>
<a name="l01360"></a>01360 
<a name="l01361"></a>01361     <a class="code" href="a01709.html#ga0a4fb62f9e69209c9c8c8e34ebb3df6f" title="This macro will protect the following code from interrupts.">AVR_ENTER_CRITICAL_REGION</a>();
<a name="l01362"></a>01362 
<a name="l01363"></a>01363     uint8_t counter = 128;
<a name="l01364"></a>01364     <span class="keywordtype">bool</span> cal_ok = <span class="keyword">false</span>;
<a name="l01365"></a>01365     <span class="keywordflow">do</span>{
<a name="l01366"></a>01366         <span class="comment">/* wait for timer to be ready for updated config */</span>
<a name="l01367"></a>01367         TCCR1B = 1 &lt;&lt; CS10;
<a name="l01368"></a>01368 
<a name="l01369"></a>01369         <span class="keywordflow">while</span> (ASSR &amp; ((1 &lt;&lt; TCN2UB)|(1 &lt;&lt; OCR2AUB)|(1 &lt;&lt; TCR2AUB)|(1 &lt;&lt; TCR2BUB))) { ; }
<a name="l01370"></a>01370 
<a name="l01371"></a>01371         TCNT2 = 0x80;
<a name="l01372"></a>01372         TCNT1 = 0;
<a name="l01373"></a>01373 
<a name="l01374"></a>01374         TIFR2 = 0xFF;
<a name="l01375"></a>01375 
<a name="l01376"></a>01376         <span class="comment">/* Wait for TIMER/COUNTER 2 to overflow. Stop TIMER/COUNTER 1 and 2, and</span>
<a name="l01377"></a>01377 <span class="comment">         * read the counter value of TIMER/COUNTER 1. It will now contain the</span>
<a name="l01378"></a>01378 <span class="comment">         * number of cpu cycles elapsed within the period.</span>
<a name="l01379"></a>01379 <span class="comment">         */</span>
<a name="l01380"></a>01380         <span class="keywordflow">while</span> (!(TIFR2 &amp; (1 &lt;&lt; TOV2))){
<a name="l01381"></a>01381             ;
<a name="l01382"></a>01382             }
<a name="l01383"></a>01383         temp = TCNT1;
<a name="l01384"></a>01384 
<a name="l01385"></a>01385         TCCR1B = 0;
<a name="l01386"></a>01386 
<a name="l01387"></a>01387 <span class="preprocessor">#define cal_upper (31250*1.05) // 32812 = 0x802c</span>
<a name="l01388"></a>01388 <span class="preprocessor"></span><span class="preprocessor">#define cal_lower (31250*0.95) // 29687 = 0x73f7</span>
<a name="l01389"></a>01389 <span class="preprocessor"></span>        <span class="comment">/* Iteratively reduce the error to be within limits */</span>
<a name="l01390"></a>01390         <span class="keywordflow">if</span> (temp &lt; cal_lower) {
<a name="l01391"></a>01391             <span class="comment">/* Too slow. Put the hammer down. */</span>
<a name="l01392"></a>01392             OSCCAL++;
<a name="l01393"></a>01393         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (temp &gt; cal_upper) {
<a name="l01394"></a>01394             <span class="comment">/* Too fast, retard. */</span>
<a name="l01395"></a>01395             OSCCAL--;
<a name="l01396"></a>01396         } <span class="keywordflow">else</span> {
<a name="l01397"></a>01397             <span class="comment">/* The CPU clock frequency is now within +/- 0.5% of the target value. */</span>
<a name="l01398"></a>01398             cal_ok = <span class="keyword">true</span>;
<a name="l01399"></a>01399         }
<a name="l01400"></a>01400 
<a name="l01401"></a>01401         counter--;
<a name="l01402"></a>01402     } <span class="keywordflow">while</span> ((counter != 0) &amp;&amp; (<span class="keyword">false</span> == cal_ok));
<a name="l01403"></a>01403 
<a name="l01404"></a>01404     <span class="keywordflow">if</span> (<span class="keyword">true</span> != cal_ok) {
<a name="l01405"></a>01405         <span class="comment">/* We failed, therefore restore previous OSCCAL value. */</span>
<a name="l01406"></a>01406         OSCCAL = osccal_original;
<a name="l01407"></a>01407     }
<a name="l01408"></a>01408 
<a name="l01409"></a>01409     TCCR2B = 0;
<a name="l01410"></a>01410 
<a name="l01411"></a>01411     ASSR &amp;= ~(1 &lt;&lt; AS2);
<a name="l01412"></a>01412 
<a name="l01413"></a>01413     <span class="comment">/* Disable both timers again to save power. */</span>
<a name="l01414"></a>01414     <span class="comment">//    PRR0 |= (1 &lt;&lt; PRTIM2);/* |(1 &lt;&lt; PRTIM1); */</span>
<a name="l01415"></a>01415 
<a name="l01416"></a>01416     <a class="code" href="a01709.html#ga770b47b04eec57748be0826a3d23503b" title="This macro must always be used in conjunction with AVR_ENTER_CRITICAL_REGION so that interrupts are e...">AVR_LEAVE_CRITICAL_REGION</a>();
<a name="l01417"></a>01417 }
<a name="l01418"></a>01418 <span class="comment"></span>
<a name="l01419"></a>01419 <span class="comment">/** @} */</span><span class="comment"></span>
<a name="l01420"></a>01420 <span class="comment">/** @} */</span>
<a name="l01421"></a>01421 <span class="comment">/*EOF*/</span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Tue May 8 2012 20:13:05 for Contiki 2.5 by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
